<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V3 Banner Facilitador - Aula Digital RD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="./qr/qrcode-generator.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 32px 32px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 0 0 32px 0;
        }

        button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .icon {
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            fill: none;
            stroke: currentColor;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .icon.fill {
            fill: currentColor;
            stroke: none;
        }

        .btn-form {
            background: #1a4d7e;
            color: white;
        }

        .btn-form:hover {
            background: #153d65;
        }

        .btn-download {
            background: #e53935;
            color: white;
        }

        .btn-download:hover {
            background: #c62828;
        }

        .btn-config {
            background: #666;
            color: white;
        }

        .btn-config:hover {
            background: #555;
        }

        .btn-versions {
            background: #00796b;
            color: white;
        }

        .btn-versions:hover {
            background: #00695c;
        }

        .btn-embed {
            background: #673ab7;
            color: white;
        }

        .btn-embed:hover {
            background: #5a2fa5;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .form-section h2 {
            color: #1a4d7e;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .required::after {
            content: " *";
            color: #e53935;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="url"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #1a4d7e;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .photo-input-container {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 420px;
            border: 1px solid #e6e9ef;
            border-radius: 8px;
            overflow: hidden;
            background: #ffffff;
        }

        .photo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            width: 100%;
        }

        .photo-input-wrapper {
            display: flex;
            align-items: center;
        }

        .photo-input-label {
            background: #eef6ff;
            color: #1a4d7e;
            padding: 10px 18px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            border-right: 1px solid rgba(0,0,0,0.06);
        }

        .photo-input-label:hover {
            background: #e6f0fb;
        }

        input[type="file"] {
            display: none;
        }

        .photo-input-status {
            color: #666;
            font-size: 14px;
            padding: 10px 16px;
            flex: 1;
        }

        .photo-input-status.has-file {
            color: #2e7d32;
            font-weight: 600;
        }

        .photo-input-status.has-file {
            color: #2e7d32;
            font-weight: 600;
        }

        .photo-wrapper {
            position: relative;
            display: none;
            margin-top: 12px;
            text-align: center;
        }

        .photo-preview {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e53935;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .remove-photo-icon {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #e53935;
            color: #fff;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .remove-photo-icon:hover {
            background: #c62828;
        }

        .modal-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 30px;
        }

        .error {
            color: #e53935;
            font-size: 12px;
            margin-top: 4px;
        }

        .success {
            color: #2e7d32;
            font-size: 12px;
            margin-top: 4px;
        }

  .preview-section {
    background: white;
    padding: 32px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }


        .device-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .device-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .device-btn:hover {
            border-color: #1a4d7e;
        }

        .device-btn.active {
            background: #1a4d7e;
            color: white;
            border-color: #1a4d7e;
        }

        .preview-container {
            display: flex;
            justify-content: center;
            overflow-x: auto;
            padding: 0;
            width: 100%;
        }

        #bannerPreview {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a4d7e 0%, #e53935 100%);
            padding: 30px;
            position: relative;
            transition: width 0.3s ease;
            width: 100%;
            max-width: 1200px;
        }

        #bannerPreview.mobile {
            width: 360px;
        }

        #bannerPreview.tablet {
            width: 600px;
        }

        #bannerPreview.desktop {
            width: 800px;
        }

        .banner-content {
            width: 100%;
            color: white;
        }

        .banner-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .banner-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .banner-photo-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }

        .banner-photo-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 700;
            color: white;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .status-dot {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #25d366;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }

        .banner-logo {
            height: 80px;
            max-width: 200px;
        }

        .banner-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .banner-school {
            font-size: 14px;
            opacity: 0.9;
        }

        .banner-contact {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 16px;
            line-height: 1.4;
        }

        .contact-item:last-child {
            margin-bottom: 0;
        }

        .banner-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .banner-button.whatsapp-personal {
            background: #25d366;
        }

        .banner-button.whatsapp-personal:hover {
            background: #1fa854;
        }

        .banner-button.whatsapp-group {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .banner-button.whatsapp-group:hover {
            background: rgba(255,255,255,0.3);
        }

        .banner-button .icon {
            margin-left: 0;
            width: 20px;
            height: 20px;
            transform: translateY(-1px);
        }

        .banner-button.whatsapp-personal .icon,
        .banner-button.whatsapp-group .icon {
            width: 24px;
            height: 24px;
        }

        .contact-item .icon {
            width: 20px;
            height: 20px;
        }

        .banner-additional {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .banner-additional h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .banner-additional p {
            font-size: 15px;
            line-height: 1.5;
            opacity: 0.95;
        }

        .banner-extra-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 14px;
        }

        .banner-extra-text {
            flex: 1;
        }

        .banner-qr {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            flex-shrink: 0;
        }

        .banner-qr img {
            display: block;
            width: 96px;
            height: 96px;
            border-radius: 6px;
        }

        @media (max-width: 640px) {
            .banner-extra-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .banner-qr {
                align-self: flex-end;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.8;
        }

        .empty-state p {
            font-size: 16px;
            color: #fff;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 750px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #1a4d7e;
            font-size: 22px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: auto;
            box-shadow: none;
        }

        .close-btn:hover {
            color: #000;
        }

        .color-picker-group {
            margin-bottom: 20px;
        }

        .color-picker-group label {
            margin-bottom: 10px;
        }

        input[type="color"] {
            width: 100%;
            height: 50px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }

        .theme-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .theme-btn {
            padding: 10px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
        }

        .theme-btn:hover {
            border-color: #1a4d7e;
        }

        .theme-btn.active {
            background: #1a4d7e;
            color: white;
            border-color: #1a4d7e;
        }

        /* New config modal styles (card-style themes and color inputs) */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 18px;
        }

        .theme-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: #fff;
            border: 1px solid #c7d3dd; /* slightly darker border */
            cursor: pointer;
            transition: box-shadow .15s ease, transform .08s ease;
        }

        .theme-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(20,40,80,0.06); }

        .theme-card.active { box-shadow: 0 10px 30px rgba(20,40,80,0.08); border-color: #1a4d7e; }

        .theme-swatches { display:flex; gap:8px; align-items:center; }
        .theme-swatch { width:34px; height:28px; border-radius:6px; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.06); }

        .theme-label { font-size: 14px; color:#163a57; font-weight:700; }
        .theme-sub { display:block; font-size:12px; color:#666; font-weight:600; }

        .color-row { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
        .color-swatch-input { width:48px; height:36px; border-radius:8px; border:1px solid #e6eef7; cursor:pointer; }
        .color-hex-input { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e6eef7; font-size:14px; }

        .apply-btn { width:100%; padding:14px; background:#1a4d7e; color:white; border:none; border-radius:10px; font-weight:800; font-size:15px; cursor:pointer; }
        .apply-btn:hover { background:#153d65; }

        /* Config preview styles */
        .config-row { display:flex; gap:20px; align-items:flex-start; margin-bottom:12px; }
        .config-preview { width: 260px; height: 140px; border-radius: 10px; overflow: hidden; border: 1px solid #c7d3dd; box-shadow: 0 8px 24px rgba(16,40,80,0.06); background: #fff; flex-shrink:0; }
        .preview-scale { transform: scale(0.33); transform-origin: top left; width: 800px; height: 420px; }
        @media (max-width: 768px) { .config-row { flex-direction: column-reverse; } .config-preview { width:100%; height:160px; } .preview-scale { transform: scale(0.28); width:700px; } }

        .export-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .export-btn {
            padding: 15px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .export-btn:hover {
            border-color: #1a4d7e;
            background: #f9f9f9;
        }

        .versions-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .version-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 2px solid #eee;
            transition: all 0.3s ease;
        }

        .version-item:hover {
            border-color: #1a4d7e;
            background: #f0f7ff;
        }

        .version-item.active {
            border-color: #1a4d7e;
            background: #e3f2fd;
        }

        .version-name {
            font-weight: 600;
            color: #1a4d7e;
            margin-bottom: 5px;
        }

        .version-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }

        .version-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .version-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #1a4d7e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .version-btn:hover {
            background: #153d65;
        }

        .version-btn.delete {
            background: #e53935;
        }

        .version-btn.delete:hover {
            background: #c62828;
        }

        .save-status {
            padding: 10px 15px;
            background: #e8f5e9;
            border-left: 4px solid #2e7d32;
            border-radius: 4px;
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 13px;
            display: none;
        }

        .save-status.show {
            display: block;
        }

        

        .form-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn-primary-full {
            flex: 1;
            justify-content: center;
        }

        .textarea-help {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .header img {
                height: 80px;
            }

            .content {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
                justify-content: center;
            }

            .banner-header {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
            }

            .modal-layout {
                grid-template-columns: 1fr;
            }

            .export-options {
                grid-template-columns: 1fr;
            }

            .theme-buttons {
                grid-template-columns: 1fr;
            }

            #bannerPreview.mobile {
                width: 100%;
            }

            #bannerPreview.tablet {
                width: 100%;
            }

            #bannerPreview.desktop {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden;">
        <symbol id="icon-form" viewBox="0 0 24 24">
            <path d="M7 4h10a1 1 0 0 1 1 1v15H6V5a1 1 0 0 1 1-1z"></path>
            <path d="M9 9h6"></path>
            <path d="M9 13h6"></path>
            <path d="M9 17h3"></path>
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24">
            <path d="M12 3v12"></path>
            <path d="m7 11 5 5 5-5"></path>
            <path d="M5 19h14"></path>
        </symbol>
        <symbol id="icon-gear" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 12a7.5 7.5 0 0 0-.06-.98l2.02-1.53-2-3.46-2.46.61a7.1 7.1 0 0 0-1.7-.99L14.7 3h-5.4l-.5 2.65a7.1 7.1 0 0 0-1.7.99l-2.46-.61-2 3.46L4.2 11c-.04.32-.06.65-.06.98 0 .33.02.66.06.98l-2.02 1.53 2 3.46 2.46-.61a7.1 7.1 0 0 0 1.7.99l.5 2.65h5.4l.5-2.65a7.1 7.1 0 0 0 1.7-.99l2.46.61 2-3.46L19.34 13c.04-.32.06-.65.06-.98z"></path>
        </symbol>
        <symbol id="icon-history" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M12 7v5l3 2"></path>
        </symbol>
        <symbol id="icon-code" viewBox="0 0 24 24">
            <path d="m9 18 3-12"></path>
            <path d="m5 14-3-2 3-2"></path>
            <path d="m15 10 3 2-3 2"></path>
        </symbol>
        <symbol id="icon-mail" viewBox="0 0 24 24">
            <path d="M4 6h16a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1z"></path>
            <path d="m4 7 8 5 8-5"></path>
        </symbol>
        <symbol id="icon-phone" viewBox="0 0 24 24">
            <path d="M6.5 3h2.7c.2 0 .4.15.45.35l.7 3a.5.5 0 0 1-.14.47L8.6 8.87a9.5 9.5 0 0 0 6.53 6.53l1.05-1.61a.5.5 0 0 1 .47-.14l3 .7c.2.05.35.25.35.46v2.7a1 1 0 0 1-1 1A12.5 12.5 0 0 1 5.5 4a1 1 0 0 1 1-1z"></path>
        </symbol>
                <symbol id="icon-whatsapp" viewBox="0 0 24 24">
            <path d="M12 3a9 9 0 0 0-7.8 13.5L3 21l4.7-1.2A9 9 0 1 0 12 3Z" fill="none"></path>
            <path d="M9.5 8.8c.2-.3.3-.5.5-.5.1 0 .3-.1.5.1.1.1.9 1 .9 1.1 0 .1.1.3 0 .5-.2.2-.3.3-.5.5-.1.1-.3.2-.2.4.1.2.5.9 1.2 1.5.8.6 1.4.8 1.6.9.1.1.3 0 .4-.1s.5-.6.7-.8.3-.1.5-.1.3 0 .4 0 .4.2.4.3.4 1.1.4 1.3-.1.3-.3.4c-.1.1-.7.4-1.4.4-.3 0-.9-.1-1.6-.4-.9-.3-1.8-1-2.5-1.8-.3-.4-.8-1-1-1.6-.4-.8-.3-1.4-.2-1.5z" fill="none"></path>
        </symbol>
    </svg>
    <div class="container">
        <div class="content">
            <div class="preview-section">
                <div class="button-group">
                    <button class="btn-form" onclick="openFormModal()">
                        <svg class="icon" aria-hidden="true"><path d="M7 4h10a1 1 0 0 1 1 1v15H6V5a1 1 0 0 1 1-1z"></path><path d="M9 9h6"></path><path d="M9 13h6"></path><path d="M9 17h3"></path></svg>
                        Formulario
                    </button>
                    <button class="btn-download" onclick="openExportModal()" id="downloadBtn">
                        <svg class="icon" aria-hidden="true"><path d="M12 3v12"></path><path d="m7 11 5 5 5-5"></path><path d="M5 19h14"></path></svg>
                        Exportar
                    </button>
                    <button class="btn-config" onclick="openConfigModal()">
                        <svg class="icon" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 12a7.5 7.5 0 0 0-.06-.98l2.02-1.53-2-3.46-2.46.61a7.1 7.1 0 0 0-1.7-.99L14.7 3h-5.4l-.5 2.65a7.1 7.1 0 0 0-1.7.99l-2.46-.61-2 3.46L4.2 11c-.04.32-.06.65-.06.98 0 .33.02.66.06.98l-2.02 1.53 2 3.46 2.46-.61a7.1 7.1 0 0 0 1.7.99l.5 2.65h5.4l.5-2.65a7.1 7.1 0 0 0 1.7-.99l2.46.61 2-3.46L19.34 13c.04-.32.06-.65.06-.98z"></path></svg>
                        Configuración
                    </button>
                    <button class="btn-versions" onclick="openVersionsModal()">
                        <svg class="icon" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><path d="M12 7v5l3 2"></path></svg>
                        Historial
                    </button>
                </div>
                <div class="preview-container">
                    <div id="bannerPreview" class="desktop">
                        <div class="empty-state">
                            <p>El Facilitador no ha actualizado</p>
                            <p>Debe contactar con Encargado de Escuela</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

            

    <!-- Form Modal -->
    <div id="formModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Datos del Facilitador</h2>
                <button class="close-btn" type="button" onclick="closeFormModal()">&times;</button>
            </div>

                <div class="form-section" style="box-shadow: none; padding: 0;">
                    <div class="save-status" id="saveStatus">Datos guardados autom&aacute;ticamente</div>

                    <div class="form-group">
                        <label class="required">Cedula</label>
                        <input type="text" id="cedula" placeholder="Ej: 001-1234567-8" onchange="saveData()" />
                        <div class="error" id="cedulaError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Nombre Completo</label>
                        <input type="text" id="name" placeholder="Ej: Prof. Maria Garcia" onchange="saveData()" />
                        <div class="error" id="nameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Escuela</label>
                        <select id="school" onchange="saveData()">
                            <option value="">Seleccionar Escuela</option>
                            <option value="educacion">Escuela de Educacion</option>
                            <option value="ciencia-tecnologia">Escuela de Ciencia y Tecnologia</option>
                            <option value="humanidades">Escuela de Humanidades</option>
                            <option value="negocios">Escuela de Negocios</option>
                            <option value="salud">Escuela de Salud</option>
                            <option value="artes">Escuela de Artes</option>
                        </select>
                        <div class="error" id="schoolError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Correo Electronico</label>
                        <input type="email" id="email" placeholder="Ej: maria.garcia@auladigitalrd.edu.do" onchange="saveData()" />
                        <div class="error" id="emailError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Telefono / Celular</label>
                        <input type="tel" id="phone" placeholder="Ej: +1 809-555-1234" onchange="saveData()" />
                        <div class="error" id="phoneError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Numero de WhatsApp personal</label>
                        <input type="tel" id="whatsappPersonal" placeholder="Ej: +1 809-555-1234" onchange="saveData()" />
                        <div class="error" id="whatsappPersonalError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Link del Grupo de WhatsApp</label>
                        <input type="url" id="whatsappGroup" placeholder="Ej: https://chat.whatsapp.com/..." onchange="saveData()" />
                        <div class="error" id="whatsappGroupError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Foto del Facilitador</label>
                        <div class="photo-row">
                            <div class="photo-input-container">
                                <div class="photo-input-wrapper">
                                    <label for="photo" class="photo-input-label">Seleccionar archivo</label>
                                    <input type="file" id="photo" accept="image/*" onchange="handlePhotoUpload()" />
                                </div>
                                <div class="photo-input-status" id="photoInputStatus">Ningun archivo seleccionado</div>
                            </div>

                            <div id="photoWrapper" class="photo-wrapper" style="margin:0;">
                                <img id="photoPreview" class="photo-preview" alt="Foto del facilitador" />
                                <button type="button" class="remove-photo-icon" onclick="removePhoto()">&times;</button>
                            </div>
                        </div>
                        <div class="error" id="photoError"></div>
                    </div>

                    <div class="form-group">
                        <label>Informacion Adicional</label>
                        <textarea id="comments" placeholder="Mensaje de bienvenida, horario, etc." onchange="saveData()"></textarea>
                        <div class="textarea-help">Este campo es opcional.</div>
                    </div>

                    <div class="form-footer">
                        <button type="button" class="btn-form btn-primary-full" onclick="submitFormModal()">Guardar y Cerrar</button>
                    </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Exportar Banner</h2>
                <button class="close-btn" type="button" onclick="closeExportModal()">&times;</button>
            </div>

            <p style="color: #666; margin-bottom: 20px;">Selecciona el formato en el que deseas descargar tu banner:</p>

            <div class="export-options">
                <button class="export-btn" onclick="downloadBanner('png')">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true"><path d="M12 3v12"></path><path d="m7 11 5 5 5-5"></path><path d="M5 19h14"></path></svg></div>
                    PNG (Transparencia)
                </button>
                <button class="export-btn" onclick="downloadBanner('jpg')">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true"><path d="M12 3v12"></path><path d="m7 11 5 5 5-5"></path><path d="M5 19h14"></path></svg></div>
                    JPG (Comprimido)
                </button>
                <!-- PDF export removed; export as image formats only -->
                <button class="export-btn" onclick="downloadBanner('webp')">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true"><path d="M12 3v12"></path><path d="m7 11 5 5 5-5"></path><path d="M5 19h14"></path></svg></div>
                    WebP (Moderno)
                </button>
                <button class="export-btn" onclick="openEmbedConfig()">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 12a7.5 7.5 0 0 0-.06-.98l2.02-1.53-2-3.46-2.46.61a7.1 7.1 0 0 0-1.7-.99L14.7 3h-5.4l-.5 2.65a7.1 7.1 0 0 0-1.7.99l-2.46-.61-2 3.46L4.2 11c-.04.32-.06.65-.06.98 0 .33.02.66.06.98l-2.02 1.53 2 3.46 2.46-.61a7.1 7.1 0 0 0 1.7.99l.5 2.65h5.4l.5-2.65a7.1 7.1 0 0 0 1.7-.99l2.46.61 2-3.46L19.34 13c.04-.32.06-.65.06-.98z"></path></svg></div>
                    Embed / Configuraci+¦n
                </button>
                <button class="export-btn" onclick="openEmbedPreview()">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true"><path d="m9 18 3-12"></path><path d="m5 14-3-2 3-2"></path><path d="m15 10 3 2-3 2"></path></svg></div>
                    Embed / Vista
                </button>
                    <!-- Embed removed: embed functionality deleted -->
            </div>

            <button type="button" onclick="closeExportModal()" class="btn-form btn-primary-full">Cancelar</button>
        </div>
    </div>

    <!-- Embed Modal -->
    <div id="embedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Insertar en Moodle / Web</h2>
                <button class="close-btn" type="button" onclick="closeEmbedModal()">&times;</button>
            </div>
            <p style="color: #666; margin-bottom: 12px;">Copia este c+¦digo e ins+¬rtalo en un bloque HTML de Moodle o en tu p+ígina.</p>
            <textarea id="embedCode" style="width:100%; min-height: 140px; padding:12px; border:1px solid #dde3eb; border-radius:10px; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 13px; resize: vertical;" readonly></textarea>
            <div style="display:flex; gap:10px; margin-top:12px;">
                <button class="btn-embed" style="flex:1; justify-content:center;" onclick="copyEmbedCode()">Copiar c+¦digo</button>
                <button class="btn-form" style="flex:1; justify-content:center;" onclick="closeEmbedModal()">Cerrar</button>
            </div>
            <div id="embedStatus" style="display:none; margin-top:10px; font-size:13px; color:#2e7d32;">C+¦digo copiado al portapapeles</div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configuraci+¦n del Banner</h2>
                <button class="close-btn" type="button" onclick="closeConfigModal()">&times;</button>
            </div>

            <div class="config-row">
                <div style="flex:1;">
                    <h3 style="color: #1a4d7e; margin-bottom: 12px; font-size: 16px;">Temas Predefinidos</h3>
                    <div class="theme-grid" id="themeGrid">
                <div class="theme-card" data-theme="sunset" onclick="selectThemeCard(this,'sunset')">
                    <div class="theme-swatches"><div class="theme-swatch" style="background:#ff6f00"></div><div class="theme-swatch" style="background:#ff1744"></div></div>
                    <div>
                        <div class="theme-label">Atardecer <span class="theme-sub">(Predeterminado)</span></div>
                    </div>
                </div>

                <div class="theme-card" data-theme="ocean" onclick="selectThemeCard(this,'ocean')">
                    <div class="theme-swatches"><div class="theme-swatch" style="background:#006994"></div><div class="theme-swatch" style="background:#00bcd4"></div></div>
                    <div>
                        <div class="theme-label">Oc+¬ano</div>
                    </div>
                </div>

                <div class="theme-card" data-theme="forest" onclick="selectThemeCard(this,'forest')">
                    <div class="theme-swatches"><div class="theme-swatch" style="background:#1b5e20"></div><div class="theme-swatch" style="background:#66bb6a"></div></div>
                    <div>
                        <div class="theme-label">Bosque</div>
                    </div>
                </div>

                <div class="theme-card" data-theme="auladigital" onclick="selectThemeCard(this,'auladigital')">
                    <div class="theme-swatches"><div class="theme-swatch" style="background:#1a4d7e"></div><div class="theme-swatch" style="background:#e53935"></div></div>
                    <div>
                        <div class="theme-label">Aula Digital</div>
                    </div>
                </div>
                    </div>
                </div>

                <div>
                    <div style="font-size:13px; color:#23445a; font-weight:700; margin-bottom:8px;">Mini preview</div>
                    <div id="configPreview" class="config-preview"><div id="previewScale" class="preview-scale"></div></div>
                </div>
            </div>

            <h3 style="color: #1a4d7e; margin-bottom: 12px; font-size: 16px; margin-top: 10px;">Colores Personalizados</h3>
            <div class="color-row">
                <div class="color-swatch-input" id="primarySwatch" onclick="document.getElementById('primaryColor').click()" style="background:#ff6f00"></div>
                <input type="color" id="primaryColor" value="#ff6f00" onchange="onPrimaryColorChange(this.value)" style="display:none;" />
                <input class="color-hex-input" id="primaryHex" value="#ff6f00" onchange="onPrimaryHexChange(this.value)" />
            </div>

            <div class="color-row">
                <div class="color-swatch-input" id="accentSwatch" onclick="document.getElementById('accentColor').click()" style="background:#ff1744"></div>
                <input type="color" id="accentColor" value="#ff1744" onchange="onAccentColorChange(this.value)" style="display:none;" />
                <input class="color-hex-input" id="accentHex" value="#ff1744" onchange="onAccentHexChange(this.value)" />
            </div>

            <div style="margin-top:14px;">
                <button type="button" class="apply-btn" onclick="applyConfigChanges()">Aplicar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Versions Modal -->
    <div id="versionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historial de Banners</h2>
                <button class="close-btn" type="button" onclick="closeVersionsModal()">&times;</button>
            </div>

            <div class="form-group">
                <label>Guardar versi+¦n actual como:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="versionName" placeholder="Ej: Banner v1 - Octubre" style="flex: 1;" />
                    <button class="btn-form" onclick="saveVersion()" style="width: auto;">Guardar</button>
                </div>
            </div>

            <h3 style="color: #1a4d7e; margin: 20px 0 15px; font-size: 16px;">Versiones Guardadas</h3>
            <div class="versions-list" id="versionsList">
                <p style="color: #999; text-align: center;">No hay versiones guardadas a+â-¦n</p>
            </div>

            <button type="button" onclick="closeVersionsModal()" class="btn-form btn-primary-full" style="margin-top: 20px;">Cerrar</button>
        </div>
    </div>

    <script>
        // Global error handlers to capture and report JS errors (helps debugging)
        window.addEventListener('error', function (e) {
            console.error('Global error caught:', e.message, 'at', e.filename + ':' + e.lineno);
            try { alert('Error JavaScript: ' + e.message + '\\nArchivo: ' + e.filename + ':' + e.lineno); } catch (err) {}
        });
        window.addEventListener('unhandledrejection', function (e) {
            console.error('Unhandled promise rejection:', e.reason);
            try { alert('Error (promise): ' + (e.reason && e.reason.message ? e.reason.message : String(e.reason))); } catch (err) {}
        });
        const SCHOOL_LABELS = {
            'Educacion': 'Escuela de Educaci+¦n',
            'ciencia-Tecnologia': 'Escuela de Ciencia y Tecnolog+¡a',
            'humanidades': 'Escuela de Humanidades',
            'negocios': 'Escuela de Negocios',
            'salud': 'Escuela de Salud',
            'artes': 'Escuela de Artes'
        };

        const THEMES = {
            'auladigital': { primary: '#1a4d7e', accent: '#e53935' },
            'ocean': { primary: '#006994', accent: '#00bcd4' },
            'forest': { primary: '#1b5e20', accent: '#66bb6a' },
            'sunset': { primary: '#ff6f00', accent: '#ff1744' }
        };

        // =ƒö¦ MODO DE EJECUCI+ôN (config / preview)
        const params = new URLSearchParams(window.location.search);
        const MODE = params.get("mode") || "config";

        let currentDeviceSize = 'mobile';

        // Drag & Drop
        function loadData() {
            const data = JSON.parse(localStorage.getItem('bannerData') || '{}');

            // Set default theme to "sunset" if none stored
            let theme = JSON.parse(localStorage.getItem('themeConfig') || '{}');
            if (!theme.primaryColor || !theme.accentColor) {
                theme = { primaryColor: THEMES['sunset'].primary, accentColor: THEMES['sunset'].accent };
                localStorage.setItem('themeConfig', JSON.stringify(theme));
            }

            if (data.name) document.getElementById('name').value = data.name;
            if (data.school) document.getElementById('school').value = data.school;
            if (data.email) document.getElementById('email').value = data.email;
            if (data.phone) document.getElementById('phone').value = data.phone;
            if (data.Cedulaa) document.getElementById('Cedulaa').value = data.Cedulaa;
            if (data.whatsappPersonal) document.getElementById('whatsappPersonal').value = data.whatsappPersonal;
            if (data.whatsappGroup) document.getElementById('whatsappGroup').value = data.whatsappGroup;
            if (data.comments) document.getElementById('comments').value = data.comments;

            if (data.photo) {
                const photoPreview = document.getElementById('photoPreview');
                const photoWrapper = document.getElementById('photoWrapper');
                const photoInputStatus = document.getElementById('photoInputStatus');
                photoPreview.src = data.photo;
                photoWrapper.style.display = 'inline-block';
                photoInputStatus.textContent = '+ó+ôGÇ£ Foto cargada';
                photoInputStatus.classList.add('has-file');
            }

            if (theme.primaryColor) document.getElementById('primaryColor').value = theme.primaryColor;
            if (theme.accentColor) document.getElementById('accentColor').value = theme.accentColor;
            if (document.getElementById('primarySwatch')) document.getElementById('primarySwatch').style.background = document.getElementById('primaryColor').value;
            if (document.getElementById('accentSwatch')) document.getElementById('accentSwatch').style.background = document.getElementById('accentColor').value;
            if (document.getElementById('primaryHex')) document.getElementById('primaryHex').value = document.getElementById('primaryColor').value;
            if (document.getElementById('accentHex')) document.getElementById('accentHex').value = document.getElementById('accentColor').value;

            loadVersionsList();
            updateBanner();
            try{ updateConfigPreview(); }catch(e){}
            
        }

        function saveData() {
            showSaveStatus();
            const photoPreview = document.getElementById('photoPreview');

            const data = {
                name: document.getElementById('name').value.trim(),
                school: document.getElementById('school').value,
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                Cedulaa: document.getElementById('Cedulaa').value.trim(),
                whatsappPersonal: document.getElementById('whatsappPersonal').value.trim(),
                whatsappGroup: document.getElementById('whatsappGroup').value.trim(),
                comments: document.getElementById('comments').value,
                photo: photoPreview && photoPreview.src ? photoPreview.src : ''
            };
            localStorage.setItem('bannerData', JSON.stringify(data));
            updateBanner();
            try{ updateConfigPreview(); }catch(e){}

            // =ƒö¦ ENVIAR CAMBIOS EN TIEMPO REAL AL CONTENEDOR
            try {
                window.parent.postMessage({
                    type: "BANNER_UPDATE",
                    payload: {
                        data: JSON.parse(localStorage.getItem('bannerData') || '{}'),
                        theme: JSON.parse(localStorage.getItem('themeConfig') || '{}')
                    }
                }, "*");
            } catch (e) {}
            
        }

        function handlePhotoUpload() {
            const input = document.getElementById('photo');
            const file = input.files[0];
            const photoPreview = document.getElementById('photoPreview');
            const photoWrapper = document.getElementById('photoWrapper');
            const photoInputStatus = document.getElementById('photoInputStatus');
            const photoError = document.getElementById('photoError');

            photoError.textContent = '';

            if (!file) return;

            if (!file.type.startsWith('image/')) {
                photoError.textContent = 'El archivo debe ser una imagen.';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                photoError.textContent = 'La imagen no debe superar 5MB.';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    photoPreview.src = e.target.result;
                    photoWrapper.style.display = 'inline-block';
                    photoInputStatus.textContent = '+ó+ôGÇ£ ' + file.name;
                    photoInputStatus.classList.add('has-file');
                    saveData();
                };
                img.onerror = () => {
                    photoError.textContent = 'El archivo no es una imagen v+â-ílida.';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            const photoPreview = document.getElementById('photoPreview');
            const photoWrapper = document.getElementById('photoWrapper');
            const photoInput = document.getElementById('photo');
            const photoInputStatus = document.getElementById('photoInputStatus');

            photoInput.value = '';
            photoPreview.src = '';
            photoWrapper.style.display = 'none';
            photoInputStatus.textContent = 'Ning+â-¦n archivo seleccionado';
            photoInputStatus.classList.remove('has-file');
            saveData();
        }

        function saveTheme() {
            showSaveStatus();
            const theme = {
                primaryColor: document.getElementById('primaryColor').value,
                accentColor: document.getElementById('accentColor').value
            };
            localStorage.setItem('themeConfig', JSON.stringify(theme));
            updateBanner();
        }

        function applyTheme(themeName) {
            const theme = THEMES[themeName];
            if (theme) {
                document.getElementById('primaryColor').value = theme.primary;
                document.getElementById('accentColor').value = theme.accent;

                // update swatches/inputs if present
                try {
                    document.getElementById('primarySwatch').style.background = theme.primary;
                    document.getElementById('accentSwatch').style.background = theme.accent;
                    if (document.getElementById('primaryHex')) document.getElementById('primaryHex').value = theme.primary;
                    if (document.getElementById('accentHex')) document.getElementById('accentHex').value = theme.accent;
                } catch(e){}

                document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
                try { event.currentTarget && event.currentTarget.classList.add('active'); } catch(e){}

                saveTheme();
            }
        }

        function selectThemeCard(el, themeName) {
            document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
            el.classList.add('active');
            applyTheme(themeName);
        }

        function onPrimaryColorChange(val) { document.getElementById('primarySwatch').style.background = val; if(document.getElementById('primaryHex')) document.getElementById('primaryHex').value = val; saveTheme(); }
        function onAccentColorChange(val) { document.getElementById('accentSwatch').style.background = val; if(document.getElementById('accentHex')) document.getElementById('accentHex').value = val; saveTheme(); }
        function onPrimaryHexChange(val) { try{ document.getElementById('primarySwatch').style.background = val; document.getElementById('primaryColor').value = val; saveTheme(); }catch(e){} }
        function onAccentHexChange(val) { try{ document.getElementById('accentSwatch').style.background = val; document.getElementById('accentColor').value = val; saveTheme(); }catch(e){} }

        function applyConfigChanges(){ saveTheme(); closeConfigModal(); }

        async function generateQrDataUrl(text, size = 200) {
            const value = (text || '').trim();
            if (!value) return '';
            const fallback = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encodeURIComponent(value)}`;

            // 1) qrcode-generator (Arase)
            if (typeof qrcode === 'function') {
                try {
                    const qr = qrcode(0, 'H');
                    qr.addData(value);
                    qr.make();
                    const cellSize = Math.max(2, Math.floor(size / 40));
                    return qr.createDataURL(cellSize, 2); // margen pequeño
                } catch (e) {
                    console.error('Error al generar el QR con qrcode-generator', e);
                }
            }

            // 2) QRCode (node-qrcode browser build)
            if (window.QRCode && typeof QRCode.toDataURL === 'function') {
                try {
                    return await QRCode.toDataURL(value, { width: size, margin: 1 });
                } catch (e) {
                    console.error('Error al generar el QR con QRCode', e);
                }
            }

            // 3) QRious (local vendored)
            if (window.QRious) {
                try {
                    const qr = new QRious({ value, size, level: 'H' });
                    if (typeof qr.toDataURL === 'function') return qr.toDataURL();
                } catch (e) {
                    console.error('Error al generar el QR con QRious', e);
                }
            }

            // 4) External fallback
            return fallback;
        }

        function updateConfigPreview(){
            try{
                const banner = document.getElementById('bannerPreview');
                const previewScale = document.getElementById('previewScale');
                if(!banner || !previewScale) return;
                // copy innerHTML and background
                previewScale.innerHTML = banner.innerHTML;
                previewScale.style.background = banner.style.background || '';
            }catch(e){ console.error('updateConfigPreview error', e); }
        }

        // Device selection removed +óGé¼GÇ¥ always show desktop preview

        async function updateBanner() {
            const data = JSON.parse(localStorage.getItem('bannerData') || '{}');
            const theme = JSON.parse(localStorage.getItem('themeConfig') || '{}');
            const primaryColor = theme.primaryColor || THEMES['sunset'].primary;
            const accentColor = theme.accentColor || THEMES['sunset'].accent;
            const qrImage = data.whatsappGroup ? await generateQrDataUrl(data.whatsappGroup, 200) : '';

            // marcar tarjeta activa seg+¦n colores actuales
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            if (primaryColor === THEMES['sunset'].primary && accentColor === THEMES['sunset'].accent) {
                const card = document.querySelector('.theme-card[data-theme=\"sunset\"]');
                if (card) card.classList.add('active');
            }

            const initial = data.name ? data.name.charAt(0).toUpperCase() : '?';

            const hasRequiredFields =
                data.name &&
                data.school &&
                data.email &&
                data.phone &&
                data.Cedulaa &&
                data.whatsappPersonal &&
                data.whatsappGroup;

            const banner = document.getElementById('bannerPreview');
            if (!hasRequiredFields) {
                banner.innerHTML = '<div class="empty-state"><p>El Facilitador no ha actualizado</p><p>Debe contactar con Encargado de Escuela</p></div>';
                banner.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
                return;
            }

            const schoolLabel = SCHOOL_LABELS[data.school] || 'Facilitador Docente';

                        banner.innerHTML = `
                <div class="banner-content">
                    <div class="banner-header">
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div class="banner-photo-wrapper">
                                ${
                                    data.photo
                                        ? `<img src="${data.photo}" alt="${data.name}" class="banner-photo" />`
                                        : `<div class="banner-photo-placeholder">${initial}</div>`
                                }
                                <span class="status-dot" title="Activo"></span>
                            </div>
                            <div>
                                <div class="banner-title">${data.name}</div>
                                <div class="banner-school">${schoolLabel}</div>
                            </div>
                        </div>
                        <img class="banner-logo" src="./recursos/img/Logo-blanco-UAPA.png" alt="Logo UAPA" loading="lazy" />
                    </div>

                    <div class="banner-contact">
                        <div class="contact-item">
                            <svg class="icon" aria-hidden="true"><path d="M4 6h16a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1z"></path><path d="m4 7 8 5 8-5"></path></svg>
                            <a href="mailto:${data.email}" style="color: white; text-decoration: none;">${data.email}</a>
                        </div>
                        <div class="contact-item">
                            <svg class="icon" aria-hidden="true"><path d="M6.5 3h2.7c.2 0 .4.15.45.35l.7 3a.5.5 0 0 1-.14.47L8.6 8.87a9.5 9.5 0 0 0 6.53 6.53l1.05-1.61a.5.5 0 0 1 .47-.14l3 .7c.2.05.35.25.35.46v2.7a1 1 0 0 1-1 1A12.5 12.5 0 0 1 5.5 4a1 1 0 0 1 1-1z"></path></svg>
                            <a href="tel:${data.phone}" style="color: white; text-decoration: none;">${data.phone}</a>
                        </div>
                        <button class="banner-button whatsapp-personal" onclick="window.open('https://wa.me/${data.whatsappPersonal.replace(/[^0-9]/g, '')}')">
                            Chat Personal
                            <svg class="icon" aria-hidden="true"><path d="M12 3a9 9 0 0 0-7.8 13.5L3 21l4.7-1.2A9 9 0 1 0 12 3Z" fill="none"></path><path d="M9.5 8.8c.2-.3.3-.5.5-.5.1 0 .3-.1.5.1.1.1.9 1 .9 1.1 0 .1.1.3 0 .5-.2.2-.3.3-.5.5-.1.1-.3.2-.2.4.1.2.5.9 1.2 1.5.8.6 1.4.8 1.6.9.1.1.3 0 .4-.1s.5-.6.7-.8.3-.1.5-.1.3 0 .4 0 .4.2.4.3.4 1.1.4 1.3-.1.3-.3.4c-.1.1-.7.4-1.4.4-.3 0-.9-.1-1.6-.4-.9-.3-1.8-1-2.5-1.8-.3-.4-.8-1-1-1.6-.4-.8-.3-1.4-.2-1.5z" fill="none"></path></svg>
                        </button>
                        <button class="banner-button whatsapp-group" onclick="window.open('${data.whatsappGroup}')">
                            Unirse al Grupo
                            <svg class="icon" aria-hidden="true"><path d="M12 3a9 9 0 0 0-7.8 13.5L3 21l4.7-1.2A9 9 0 1 0 12 3Z" fill="none"></path><path d="M9.5 8.8c.2-.3.3-.5.5-.5.1 0 .3-.1.5.1.1.1.9 1 .9 1.1 0 .1.1.3 0 .5-.2.2-.3.3-.5.5-.1.1-.3.2-.2.4.1.2.5.9 1.2 1.5.8.6 1.4.8 1.6.9.1.1.3 0 .4-.1s.5-.6.7-.8.3-.1.5-.1.3 0 .4 0 .4.2.4.3.4 1.1.4 1.3-.1.3-.3.4c-.1.1-.7.4-1.4.4-.3 0-.9-.1-1.6-.4-.9-.3-1.8-1-2.5-1.8-.3-.4-.8-1-1-1.6-.4-.8-.3-1.4-.2-1.5z" fill="none"></path></svg>
                        </button>
                    </div>

                                        ${
                        data.comments || qrImage
                            ? `
                        <div class="banner-additional">
                            <div class="banner-extra-row">
                                <div class="banner-extra-text">
                                    ${data.comments ? `<h4>Información Adicional</h4><p>${data.comments.replace(/\\n/g, '<br>')}</p>` : `<h4>Grupo de WhatsApp</h4><p>Escanea el código para unirte al grupo.</p>`}
                                </div>
                                ${qrImage ? `<div class="banner-qr"><img src="${qrImage}" alt="QR del grupo de WhatsApp" width="96" height="96" /></div>` : ''}
                            </div>
                        </div>
                    `
                            : ''
                    }
                </div>
            `;

            banner.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
            // Embed functionality removed
        }

        function validateForm() {
            let isValid = true;

            const name = document.getElementById('name').value.trim();
            const school = document.getElementById('school').value;
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const Cedulaa = document.getElementById('Cedulaa').value.trim();
            const photoPreview = document.getElementById('photoPreview');
            const whatsappPersonal = document.getElementById('whatsappPersonal').value.trim();
            const whatsappGroup = document.getElementById('whatsappGroup').value.trim();

            const nameError = document.getElementById('nameError');
            const schoolError = document.getElementById('schoolError');
            const emailError = document.getElementById('emailError');
            const phoneError = document.getElementById('phoneError');
            const CedulaaError = document.getElementById('CedulaaError');
            const wpPersonalError = document.getElementById('whatsappPersonalError');
            const wpGroupError = document.getElementById('whatsappGroupError');
            const photoError = document.getElementById('photoError');

            nameError.textContent = '';
            schoolError.textContent = '';
            emailError.textContent = '';
            phoneError.textContent = '';
            CedulaaError.textContent = '';
            wpPersonalError.textContent = '';
            wpGroupError.textContent = '';
            if (photoError) photoError.textContent = '';

            if (!name) {
                nameError.textContent = 'Este campo es obligatorio.';
                isValid = false;
            }

            if (!school) {
                schoolError.textContent = 'Seleccione una escuela.';
                isValid = false;
            }

            if (!email) {
                emailError.textContent = 'Este campo es obligatorio.';
                isValid = false;
            } else if (!/^\S+@\S+\.\S+$/.test(email)) {
                emailError.textContent = 'Ingrese un correo v+â-ílido.';
                isValid = false;
            }

            if (!phone) {
                phoneError.textContent = 'Este campo es obligatorio.';
                isValid = false;
            }

            if (!Cedulaa) {
                CedulaaError.textContent = 'Este campo es obligatorio.';
                isValid = false;
            }

            if (!whatsappPersonal) {
                wpPersonalError.textContent = 'Este campo es obligatorio.';
                isValid = false;
            }

            if (!whatsappGroup) {
                wpGroupError.textContent = 'Este campo es obligatorio.';
                isValid = false;
            } else if (!/^https?:\/\//i.test(whatsappGroup)) {
                wpGroupError.textContent = 'Ingrese un enlace v+â-ílido (http o https).';
                isValid = false;
            }

            return isValid;
        }

        function submitFormModal() {
            if (!validateForm()) {
                return;
            }
            saveData();
            closeFormModal();
        }

        async function downloadBanner(format) {
            const banner = document.getElementById('bannerPreview');
            if (banner.querySelector('.empty-state')) {
                alert('Completa todos los campos obligatorios primero.');
                return;
            }

            const data = JSON.parse(localStorage.getItem('bannerData') || '{}');
            const btn = document.activeElement;
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = '+ó-Å-¦ Procesando...';

            try {
                const canvas = await html2canvas(banner, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false
                });

                const safeName = (data.name || 'banner-facilitador').replace(/\s+/g, '-').toLowerCase();
                const link = document.createElement('a');
                
                // Export as image formats only (PNG, JPG, WebP)
                const mimeType = format === 'jpg' ? 'image/jpeg' : format === 'webp' ? 'image/webp' : 'image/png';
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = `banner-${safeName}.${format}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, mimeType, format === 'jpg' ? 0.95 : 1);
            } catch (err) {
                console.error('Error descargando:', err);
                alert('Error al descargar el banner.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function saveVersion() {
            const versionName = document.getElementById('versionName').value.trim();
            if (!versionName) {
                alert('Ingresa un nombre para la versi+â-¦n.');
                return;
            }

            const data = JSON.parse(localStorage.getItem('bannerData') || '{}');
            const theme = JSON.parse(localStorage.getItem('themeConfig') || '{}');
            
            const version = {
                id: Date.now(),
                name: versionName,
                date: new Date().toLocaleDateString('es-ES'),
                data: data,
                theme: theme
            };

            const versions = JSON.parse(localStorage.getItem('bannerVersions') || '[]');
            versions.push(version);
            localStorage.setItem('bannerVersions', JSON.stringify(versions));

            document.getElementById('versionName').value = '';
            alert('+ó+ôGÇ£ Versi+â-¦n guardada correctamente');
            loadVersionsList();
        }

        function loadVersionsList() {
            const versions = JSON.parse(localStorage.getItem('bannerVersions') || '[]');
            const listContainer = document.getElementById('versionsList');

            if (versions.length === 0) {
                listContainer.innerHTML = '<p style="color: #999; text-align: center;">No hay versiones guardadas a+â-¦n</p>';
                return;
            }

            listContainer.innerHTML = versions.reverse().map(version => `
                <div class="version-item">
                    <div class="version-name">${version.name}</div>
                    <div class="version-date">${version.date}</div>
                    <div class="version-buttons">
                        <button class="version-btn" onclick="loadVersion(${version.id})">Cargar</button>
                        <button class="version-btn delete" onclick="deleteVersion(${version.id})">Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        function loadVersion(versionId) {
            const versions = JSON.parse(localStorage.getItem('bannerVersions') || '[]');
            const version = versions.find(v => v.id === versionId);

            if (!version) return;

            localStorage.setItem('bannerData', JSON.stringify(version.data));
            localStorage.setItem('themeConfig', JSON.stringify(version.theme));

            loadData();
            closeVersionsModal();
            alert('+ó+ôGÇ£ Versi+â-¦n cargada correctamente');
        }

        function deleteVersion(versionId) {
            if (!confirm('+é-+Est+â-ís seguro de que deseas eliminar esta versi+â-¦n?')) return;

            const versions = JSON.parse(localStorage.getItem('bannerVersions') || '[]');
            const filtered = versions.filter(v => v.id !== versionId);
            localStorage.setItem('bannerVersions', JSON.stringify(filtered));

            loadVersionsList();
        }

        function showSaveStatus() {
            const status = document.getElementById('saveStatus');
            status.classList.add('show');
            setTimeout(() => status.classList.remove('show'), 2000);
        }

        function openFormModal() {
            document.getElementById('formModal').classList.add('active');
        }

        function closeFormModal() {
            document.getElementById('formModal').classList.remove('active');
        }

        function openExportModal() {
            const banner = document.getElementById('bannerPreview');
            if (banner.querySelector('.empty-state')) {
                alert('Completa todos los campos obligatorios primero.');
                return;
            }
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function openEmbedModal() {
            const placeholderSrc = 'https://tuservidor.com/banner.html';
            const code = `<iframe src=\"${placeholderSrc}\" width=\"900\" height=\"450\" style=\"border:0; overflow:hidden;\" allowfullscreen loading=\"lazy\"></iframe>`;
            const textarea = document.getElementById('embedCode');
            if (textarea) textarea.value = code;
            document.getElementById('embedModal').classList.add('active');
        }

        function openEmbedConfig() {
            const src = "https://edgarcastillo083dv.github.io/Banner_Docente/?mode=config";
            const code = `<iframe src="${src}" width="100%" height="650" style="border:0; overflow:hidden;" loading="lazy"></iframe>`;
            showEmbedCode(code);
        }

        function openEmbedPreview() {
            const version = Date.now(); // cache-buster para LMS (Moodle)
            const src = `https://edgarcastillo083dv.github.io/Banner_Docente/?mode=preview&v=${version}`;
            const code = `<iframe src="${src}" width="900" height="450" style="border:0; overflow:hidden;" loading="lazy"></iframe>`;
            showEmbedCode(code);
        }

        function showEmbedCode(code) {
            const textarea = document.getElementById("embedCode");
            const modal = document.getElementById("embedModal");
            textarea.value = code;
            modal.classList.add("active");
        }

        function closeEmbedModal() {
            document.getElementById('embedModal').classList.remove('active');
        }

        async function copyEmbedCode() {
            const textarea = document.getElementById('embedCode');
            const status = document.getElementById('embedStatus');
            if (!textarea) return;
            const code = textarea.value;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(code);
                } else {
                    textarea.select();
                    document.execCommand('copy');
                }
                if (status) {
                    status.style.display = 'block';
                    setTimeout(() => status.style.display = 'none', 2000);
                }
            } catch (e) {
                alert('No se pudo copiar. Copia manualmente con Ctrl+C.');
            }
        }

        function openConfigModal() {
            document.getElementById('configModal').classList.add('active');
            try{ updateConfigPreview(); }catch(e){}
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        function openVersionsModal() {
            document.getElementById('versionsModal').classList.add('active');
        }

        function closeVersionsModal() {
            document.getElementById('versionsModal').classList.remove('active');
        }

        

        window.onclick = function (event) {
            const formModal = document.getElementById('formModal');
            const exportModal = document.getElementById('exportModal');
            const configModal = document.getElementById('configModal');
            const versionsModal = document.getElementById('versionsModal');
            const embedModal = document.getElementById('embedModal');
            
            if (event.target === formModal) formModal.classList.remove('active');
            if (event.target === exportModal) exportModal.classList.remove('active');
            if (event.target === configModal) configModal.classList.remove('active');
            if (event.target === versionsModal) versionsModal.classList.remove('active');
            if (event.target === embedModal) embedModal.classList.remove('active');
        };

        // Initialize
        loadData();
        try { updateBanner(); } catch (e) { console.error(e); }

        // =ƒö¦ SOLO EN MODO PREVIEW: ESCUCHAR ACTUALIZACIONES
        if (MODE === "preview") {
            window.addEventListener("message", (event) => {
                if (!event.data || event.data.type !== "BANNER_UPDATE") return;

                localStorage.setItem(
                    "bannerData",
                    JSON.stringify(event.data.payload.data)
                );

                localStorage.setItem(
                    "themeConfig",
                    JSON.stringify(event.data.payload.theme)
                );

                updateBanner();
            });

            // Opcional: ocultar botones en preview
            try {
                document.querySelector(".button-group")?.remove();
                document.querySelector(".header")?.remove();
                document.querySelectorAll(".form-section").forEach(el => el.remove());
                const previewTitle = document.querySelector(".preview-section h2");
                if (previewTitle) previewTitle.remove();

                // Dejar solo el banner en pantalla
                const banner = document.getElementById("bannerPreview");
                const previewSection = document.querySelector(".preview-section");
                if (banner && previewSection) {
                    previewSection.replaceWith(banner);
                    banner.style.margin = "0 auto";
                    banner.style.maxWidth = "900px";
                }
                document.body.style.padding = "20px";
                document.querySelector(".container")?.style.setProperty("max-width", "100%");
                document.querySelector(".container")?.style.setProperty("margin", "0");
            } catch (e) {}
        }
    </script>
</body>
</html>
           

















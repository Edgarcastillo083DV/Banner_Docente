<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V3 Banner Facilitador - Aula Digital RD</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./qr/qrcode-generator.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 32px 32px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 0 0 32px 0;
        }

        .db-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            background: #eef1f6;
            color: #4a5b6a;
        }

        .db-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9e9e9e;
        }

        .db-status.ok .dot {
            background: #2e7d32;
        }

        .db-status.error .dot {
            background: #e53935;
        }

        .db-status.warn .dot {
            background: #f9a825;
        }

        .toast {
            position: fixed;
            right: 24px;
            top: 24px;
            background: #ffffff;
            color: #1f2937;
            padding: 14px 18px;
            border-radius: 12px;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
            border: 1px solid rgba(15, 23, 42, 0.08);
            opacity: 0;
            transform: translateY(-6px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 2000;
            font-size: 14px;
            font-weight: 600;
            min-width: 220px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            border-left: 4px solid #22c55e;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .icon {
            width: 18px;
            height: 18px;
            display: inline-flex;             align-items: center;             justify-content: center;             overflow: visible;
            fill: none;
            stroke: currentColor;
            stroke-width: 1.8;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .icon.fill {
            fill: currentColor;
            stroke: none;
        }

        .btn-form {
            background: #1a4d7e;
            color: white;
        }

        .btn-form:hover {
            background: #153d65;
        }

        .btn-download {
            background: #e53935;
            color: white;
        }

        .btn-download:hover {
            background: #c62828;
        }

        .btn-config {
            background: #666;
            color: white;
        }

        .btn-config:hover {
            background: #555;
        }

        .btn-versions {
            background: #00796b;
            color: white;
        }

        .btn-versions:hover {
            background: #00695c;
        }

        .btn-embed {
            background: #673ab7;
            color: white;
        }

        .btn-embed:hover {
            background: #5a2fa5;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .form-section h2 {
            color: #1a4d7e;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .required::after {
            content: " *";
            color: #e53935;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus,
        input[type="email"]:focus,
        input[type="tel"]:focus,
        input[type="url"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #1a4d7e;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .photo-input-container {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 420px;
            border: 1px solid #e6e9ef;
            border-radius: 8px;
            overflow: hidden;
            background: #ffffff;
        }

        .photo-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            width: 100%;
        }

        .photo-input-wrapper {
            display: flex;
            align-items: center;
        }

        .photo-input-label {
            background: #eef6ff;
            color: #1a4d7e;
            padding: 10px 18px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
            border-right: 1px solid rgba(0,0,0,0.06);
        }

        .photo-input-label:hover {
            background: #e6f0fb;
        }

        input[type="file"] {
            display: none;
        }

        .photo-input-status {
            color: #666;
            font-size: 14px;
            padding: 10px 16px;
            flex: 1;
        }

        .photo-input-status.has-file {
            color: #2e7d32;
            font-weight: 600;
        }

        .photo-wrapper {
            position: relative;
            display: none;
            margin-top: 12px;
            text-align: center;
        }

        .photo-preview {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e53935;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .remove-photo-icon {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #e53935;
            color: #fff;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .remove-photo-icon:hover {
            background: #c62828;
        }

        .modal-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 30px;
        }

        .error {
            color: #e53935;
            font-size: 12px;
            margin-top: 4px;
        }

        .success {
            color: #2e7d32;
            font-size: 12px;
            margin-top: 4px;
        }

        .field-locked {
            background: #f3f4f6;
            color: #6b7280;
            border-color: #e5e7eb;
            cursor: not-allowed;
        }

        .field-locked.photo-input-label {
            pointer-events: none;
            opacity: 0.7;
        }

        .field-locked .remove-photo-icon {
            pointer-events: none;
            opacity: 0.6;
        }

        /* Launcher  modal wrapper */
        .app-launcher {
            position: fixed;
            right: 20px;
            bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1a4d7e;
            color: #fff;
            padding: 12px 14px;
            border-radius: 24px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.22);
            cursor: pointer;
            z-index: 1200;
            font-weight: 700;
        }

        .app-launcher:hover {
            background: #153d65;
        }

        .app-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 1100;
        }

        .app-modal.show {
            display: flex;
        }

        .app-modal-content {
            position: relative;
            background: #f7f9fc;
            width: min(1100px, 96vw);
            max-height: 92vh;
            overflow-y: auto;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.28);
            padding: 16px;
        }

        .app-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #e53935;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 6px 18px rgba(0,0,0,0.25);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .app-modal-close:hover {
            background: #c62828;
        }

  .preview-section {
    background: white;
    padding: 32px;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }


        .device-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .device-btn {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .device-btn:hover {
            border-color: #1a4d7e;
        }

        .device-btn.active {
            background: #1a4d7e;
            color: white;
            border-color: #1a4d7e;
        }

        .preview-container {
            display: flex;
            justify-content: center;
            overflow-x: auto;
            padding: 0;
            width: 100%;
        }

        #bannerPreview {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a4d7e 0%, #e53935 100%);
            padding: 30px;
            position: relative;
            transition: width 0.3s ease;
            width: 100%;
            max-width: 1200px;
        }

        #bannerPreview.mobile {
            width: 360px;
        }

        #bannerPreview.tablet {
            width: 600px;
        }

        #bannerPreview.desktop {
            width: 800px;
        }

        .banner-content {
            width: 100%;
            color: white;
        }

        .banner-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .banner-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .banner-photo-wrapper {
            position: relative;
            width: 80px;
            height: 80px;
            flex-shrink: 0;
        }

        .banner-photo-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            font-weight: 700;
            color: white;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .status-dot {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #25d366;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.25);
        }

        .banner-logo {
            height: 80px;
            max-width: 200px;
        }

        .banner-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .banner-school {
            font-size: 14px;
            opacity: 0.9;
        }

        .banner-contact {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            font-size: 16px;
            line-height: 1.4;
        }

        .contact-item:last-child {
            margin-bottom: 0;
        }

        .banner-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .banner-button.whatsapp-personal {
            background: #25d366;
        }

        .banner-button.whatsapp-personal:hover {
            background: #1fa854;
        }

        .banner-button.whatsapp-group {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .banner-button.whatsapp-group:hover {
            background: rgba(255,255,255,0.3);
        }

        .banner-button .icon {
            margin-left: 0;
            width: 20px;
            height: 20px;
            transform: translateY(-1px);
        }

        .banner-button.whatsapp-personal .icon,
        .banner-button.whatsapp-group .icon {
            width: 24px;
            height: 24px;
        }

        .contact-item .icon {
            width: 20px;
            height: 20px;
        }

        .banner-additional {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .banner-additional h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .banner-additional p {
            font-size: 15px;
            line-height: 1.5;
            opacity: 0.95;
        }

        .banner-extra-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 14px;
        }

        .banner-extra-text {
            flex: 1;
        }

        .banner-qr {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            flex-shrink: 0;
        }

        .banner-qr img {
            display: block;
            width: 96px;
            height: 96px;
            border-radius: 6px;
        }

        @media (max-width: 640px) {
            .banner-extra-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .banner-qr {
                align-self: flex-end;
            }
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.8;
        }

        .empty-state p {
            font-size: 16px;
            color: #fff;
            font-weight: 700;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 750px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #1a4d7e;
            font-size: 22px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: auto;
            box-shadow: none;
        }

        .close-btn:hover {
            color: #000;
        }

        .modal-header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-edit {
            border: 1px solid #c7d3dd;
            background: #eef6ff;
            color: #1a4d7e;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
        }

        .btn-edit:hover {
            background: #e6f0fb;
        }

        .btn-edit:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-edit:focus-visible {
            outline: 3px solid #1a4d7e;
            outline-offset: 2px;
        }

        .app-modal-close:focus-visible,
        .close-btn:focus-visible {
            outline: 3px solid #1a4d7e;
            outline-offset: 2px;
        }
        .color-picker-group {
            margin-bottom: 20px;
        }

        .color-picker-group label {
            margin-bottom: 10px;
        }

        input[type="color"] {
            width: 100%;
            height: 50px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
        }

        .theme-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .theme-btn {
            padding: 10px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 600;
        }

        .theme-btn:hover {
            border-color: #1a4d7e;
        }

        .theme-btn.active {
            background: #1a4d7e;
            color: white;
            border-color: #1a4d7e;
        }

        /* New config modal styles (card-style themes and color inputs) */
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 18px;
        }

        .theme-card {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: #fff;
            border: 1px solid #c7d3dd; /* slightly darker border */
            cursor: pointer;
            transition: box-shadow .15s ease, transform .08s ease;
        }

        .theme-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(20,40,80,0.06); }

        .theme-card.active { box-shadow: 0 10px 30px rgba(20,40,80,0.08); border-color: #1a4d7e; }

        .theme-swatches { display:flex; gap:8px; align-items:center; }
        .theme-swatch { width:34px; height:28px; border-radius:6px; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.06); border:1px solid rgba(0,0,0,0.06); }

        .theme-label { font-size: 14px; color:#163a57; font-weight:700; }
        .theme-sub { display:block; font-size:12px; color:#666; font-weight:600; }

        .color-row { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
        .color-swatch-input { width:48px; height:36px; border-radius:8px; border:1px solid #e6eef7; cursor:pointer; }
        .color-hex-input { flex:1; padding:10px 12px; border-radius:8px; border:1px solid #e6eef7; font-size:14px; }

        .apply-btn { width:100%; padding:14px; background:#1a4d7e; color:white; border:none; border-radius:10px; font-weight:800; font-size:15px; cursor:pointer; }
        .apply-btn:hover { background:#153d65; }

        /* Config preview styles */
        .config-row { display:flex; gap:20px; align-items:flex-start; margin-bottom:12px; }
        .config-preview { width: 260px; height: 140px; border-radius: 10px; overflow: hidden; border: 1px solid #c7d3dd; box-shadow: 0 8px 24px rgba(16,40,80,0.06); background: #fff; flex-shrink:0; }
        .preview-scale { transform: scale(0.33); transform-origin: top left; width: 800px; height: 420px; }
        @media (max-width: 768px) { .config-row { flex-direction: column-reverse; } .config-preview { width:100%; height:160px; } .preview-scale { transform: scale(0.28); width:700px; } }

        .export-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .export-btn {
            padding: 15px;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .export-btn:hover {
            border-color: #1a4d7e;
            background: #f9f9f9;
        }

        .versions-modal-content {
            background: #f7f9fc;
        }

        .versions-modal-content .modal-header {
            border-bottom: none;
            margin-bottom: 8px;
        }

        .versions-save {
            background: #fff;
            border: 1px solid #e6e9ef;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 20px rgba(20, 40, 80, 0.06);
            margin-bottom: 18px;
        }

        .versions-title {
            color: #1a4d7e;
            margin: 18px 0 12px;
            font-size: 16px;
        }

        .versions-list {
            max-height: 320px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #e6e9ef;
            border-radius: 12px;
            padding: 12px;
        }

        .version-rename {
            margin-top: 14px;
            background: #fff;
            border: 1px solid #e6e9ef;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 6px 16px rgba(20, 40, 80, 0.06);
            display: none;
        }

        .version-rename h4 {
            margin-bottom: 8px;
            color: #1a4d7e;
            font-size: 14px;
        }

        .version-rename input {
            width: 100%;
            padding: 10px;
            border: 1px solid #c7d3dd;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .version-rename .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .version-item {
            background: #fff;
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #e6e9ef;
            box-shadow: 0 6px 16px rgba(20, 40, 80, 0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .version-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(20, 40, 80, 0.12);
        }

        .version-item.active {
            border-color: #1a4d7e;
            box-shadow: 0 12px 24px rgba(20, 40, 80, 0.14);
        }

        .version-name {
            font-weight: 600;
            color: #1a4d7e;
            margin-bottom: 5px;
        }

        .version-date {
            font-size: 12px;
            color: #999;
            margin-bottom: 10px;
        }

        .version-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .version-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: #1a4d7e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .version-btn:hover {
            background: #153d65;
        }

        .version-btn.delete {
            background: #e53935;
        }

        .version-btn.delete:hover {
            background: #c62828;
        }

        .save-status {
            padding: 10px 15px;
            background: #e8f5e9;
            border-left: 4px solid #2e7d32;
            border-radius: 4px;
            color: #2e7d32;
            margin-bottom: 20px;
            font-size: 13px;
            display: none;
        }

        .save-status.show {
            display: block;
        }

        

        .form-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .btn-primary-full {
            flex: 1;
            justify-content: center;
        }

        .textarea-help {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 24px;
            }

            .header img {
                height: 80px;
            }

            .content {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            button {
                width: 100%;
                justify-content: center;
            }

            .banner-header {
                flex-direction: column;
            }

            .modal-content {
                width: 95%;
            }

            .modal-layout {
                grid-template-columns: 1fr;
            }

            .export-options {
                grid-template-columns: 1fr;
            }

            .theme-buttons {
                grid-template-columns: 1fr;
            }

            #bannerPreview.mobile {
                width: 100%;
            }

            #bannerPreview.tablet {
                width: 100%;
            }

            #bannerPreview.desktop {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <svg aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden;">
        <symbol id="icon-form" viewBox="0 0 24 24">
            <path d="M7 4h10a1 1 0 0 1 1 1v15H6V5a1 1 0 0 1 1-1z"></path>
            <path d="M9 9h6"></path>
            <path d="M9 13h6"></path>
            <path d="M9 17h3"></path>
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24">
            <path d="M12 3v12"></path>
            <path d="m7 11 5 5 5-5"></path>
            <path d="M5 19h14"></path>
        </symbol>
        <symbol id="icon-gear" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 12a7.5 7.5 0 0 0-.06-.98l2.02-1.53-2-3.46-2.46.61a7.1 7.1 0 0 0-1.7-.99L14.7 3h-5.4l-.5 2.65a7.1 7.1 0 0 0-1.7.99l-2.46-.61-2 3.46L4.2 11c-.04.32-.06.65-.06.98 0 .33.02.66.06.98l-2.02 1.53 2 3.46 2.46-.61a7.1 7.1 0 0 0 1.7.99l.5 2.65h5.4l.5-2.65a7.1 7.1 0 0 0 1.7-.99l2.46.61 2-3.46L19.34 13c.04-.32.06-.65.06-.98z"></path>
        </symbol>
        <symbol id="icon-history" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M12 7v5l3 2"></path>
        </symbol>
        <symbol id="icon-code" viewBox="0 0 24 24">
            <path d="m9 18 3-12"></path>
            <path d="m5 14-3-2 3-2"></path>
            <path d="m15 10 3 2-3 2"></path>
        </symbol>
        <symbol id="icon-mail" viewBox="0 0 24 24">
            <path d="M4 6h16a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1z"></path>
            <path d="m4 7 8 5 8-5"></path>
        </symbol>
        <symbol id="icon-phone" viewBox="0 0 24 24">
            <path d="M6.5 3h2.7c.2 0 .4.15.45.35l.7 3a.5.5 0 0 1-.14.47L8.6 8.87a9.5 9.5 0 0 0 6.53 6.53l1.05-1.61a.5.5 0 0 1 .47-.14l3 .7c.2.05.35.25.35.46v2.7a1 1 0 0 1-1 1A12.5 12.5 0 0 1 5.5 4a1 1 0 0 1 1-1z"></path>
        </symbol>
                <symbol id="icon-whatsapp" viewBox="0 0 24 24">
            <path d="M12 3a9 9 0 0 0-7.8 13.5L3 21l4.7-1.2A9 9 0 1 0 12 3Z" fill="none"></path>
            <path d="M9.5 8.8c.2-.3.3-.5.5-.5.1 0 .3-.1.5.1.1.1.9 1 .9 1.1 0 .1.1.3 0 .5-.2.2-.3.3-.5.5-.1.1-.3.2-.2.4.1.2.5.9 1.2 1.5.8.6 1.4.8 1.6.9.1.1.3 0 .4-.1s.5-.6.7-.8.3-.1.5-.1.3 0 .4 0 .4.2.4.3.4 1.1.4 1.3-.1.3-.3.4c-.1.1-.7.4-1.4.4-.3 0-.9-.1-1.6-.4-.9-.3-1.8-1-2.5-1.8-.3-.4-.8-1-1-1.6-.4-.8-.3-1.4-.2-1.5z" fill="none"></path>
        </symbol>
	    </svg>

    <div class="container">
        <div class="content">
            <div class="preview-section">
                <div class="button-group">
                    <button class="btn-form" onclick="openFormModal()">
                        <svg class="icon" aria-hidden="true"><use href="#icon-form"></use></svg>
                        Formulario
                    </button>
                    <button class="btn-download" onclick="openExportModal()" id="downloadBtn">
                        <svg class="icon" aria-hidden="true"><use href="#icon-download"></use></svg>
                        Exportar
                    </button>
                    <button class="btn-config" onclick="openConfigModal()">
                        <svg class="icon" aria-hidden="true"><use href="#icon-gear"></use></svg>
                        Configuraci�n
                    </button>
                    <button class="btn-versions" onclick="openVersionsModal()">
                        <svg class="icon" aria-hidden="true"><use href="#icon-history"></use></svg>
                        Historial
                    </button>
                    <div id="dbStatus" class="db-status warn" aria-live="polite">
                        <span class="dot" aria-hidden="true"></span>
                        <span class="text">Base de datos: verificando...</span>
                    </div>
                </div>
                <div class="preview-container">
                    <div id="bannerPreview" class="desktop">
                        <div class="empty-state">
                            <p>El Facilitador no ha actualizado</p>
                            <p>Debe contactar con Encargado de Escuela</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
    <div id="formModal" class="modal">
            <div class="modal-content">
            <div class="modal-header">
                <h2>Datos del Facilitador</h2>
                <div class="modal-header-actions">
                    <button class="btn-edit" id="editFacilitatorBtn" type="button" onclick="enableFacilitatorEditing()" disabled>Editar facilitador</button>
                    <button class="btn-edit" type="button" onclick="clearFormAndClose()">Limpiar</button>
                    <button class="close-btn" type="button" aria-label="Cerrar" onclick="closeFormModal()">&times;</button>
                </div>
            </div>

                <div class="form-section" style="box-shadow: none; padding: 0;">
                    <div class="save-status" id="saveStatus">Datos guardados autom&aacute;ticamente</div>

                    <div class="form-group">
                        <label class="required">Cedula</label>
                        <input type="text" id="cedula" placeholder="Ej: 001-1234567-8" />
                        <div class="error" id="cedulaError"></div>
                        <div class="success" id="cedulaStatus"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Nombre Completo</label>
                        <input type="text" id="name" placeholder="Ej: Prof. Maria Garcia" />
                        <div class="error" id="nameError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Escuela</label>
                        <select id="school">
                            <option value="">Seleccionar Escuela</option>
                        <option value="educacion">Escuela de Educaci�n</option>
                        <option value="ciencia-tecnologia">Escuela de Ciencia y Tecnolog�a</option>
                            <option value="humanidades">Escuela de Humanidades</option>
                            <option value="negocios">Escuela de Negocios</option>
                            <option value="salud">Escuela de Salud</option>
                            <option value="artes">Escuela de Artes</option>
                        </select>
                        <div class="error" id="schoolError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Correo Electronico</label>
                        <input type="email" id="email" placeholder="Ej: maria.garcia@auladigitalrd.edu.do" />
                        <div class="error" id="emailError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Tel�fono / Celular</label>
                        <input type="tel" id="phone" placeholder="Ej: 1 809-555-1234" />
                        <div class="error" id="phoneError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">N�mero de WhatsApp personal</label>
                        <input type="tel" id="whatsappPersonal" placeholder="Ej: 1 809-555-1234" />
                        <div class="error" id="whatsappPersonalError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Link del Grupo de WhatsApp</label>
                        <input type="url" id="whatsappGroup" placeholder="Ej: https://chat.whatsapp.com/..." />
                        <div class="error" id="whatsappGroupError"></div>
                    </div>

                    <div class="form-group">
                        <label class="required">Foto del Facilitador</label>
                        <div class="photo-row">
                            <div class="photo-input-container">
                                <div class="photo-input-wrapper">
                                    <label for="photo" class="photo-input-label" id="photoInputLabel">Seleccionar archivo</label>
                                    <input type="file" id="photo" accept="image/*" onchange="handlePhotoUpload()" />
                                </div>
                                <div class="photo-input-status" id="photoInputStatus">Ning�n archivo seleccionado</div>
                            </div>

                            <div id="photoWrapper" class="photo-wrapper" style="margin:0;">
                                <img id="photoPreview" class="photo-preview" alt="Foto del facilitador" onerror="this.src=''" />
                                <button type="button" class="remove-photo-icon" id="removePhotoBtn" onclick="removePhoto()">&times;</button>
                            </div>
                        </div>
                        <div class="error" id="photoError"></div>
                    </div>

                    <div class="form-group">
                        <label>Informaci�n Adicional</label>
                        <textarea id="comments" placeholder="Mensaje de bienvenida, horario, etc."></textarea>
                        <div class="textarea-help">Este campo es opcional.</div>
                    </div>

                    <div class="form-footer">
                        <button type="button" class="btn-form btn-primary-full" onclick="submitFormModal()">Guardar y Cerrar</button>
                    </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Exportar Banner</h2>
                <button class="close-btn" type="button" aria-label="Cerrar" onclick="closeExportModal()">&times;</button>
            </div>

            <p style="color: #666; margin-bottom: 20px;">Selecciona el formato en el que deseas descargar tu banner:</p>

            <div class="export-options">
                <button class="export-btn" onclick="downloadBanner('png')">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"></path><path d="m7 11 5 5 5-5"></path><path d="M5 19h14"></path></svg></div>
                    PNG (Transparencia)
                </button>
                <button class="export-btn" onclick="downloadBanner('jpg')">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"></path><path d="m7 11 5 5 5-5"></path><path d="M5 19h14"></path></svg></div>
                    JPG (Comprimido)
                </button>
                <!-- PDF export removed; export as image formats only -->
                <button class="export-btn" onclick="downloadBanner('webp')">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3v12"></path><path d="m7 11 5 5 5-5"></path><path d="M5 19h14"></path></svg></div>
                    WebP (Moderno)
                </button>
                <button class="export-btn" onclick="openEmbedGenerator()">
                    <div style="font-size: 24px; margin-bottom: 8px;"><svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 12a7.5 7.5 0 0 0-.06-.98l2.02-1.53-2-3.46-2.46.61a7.1 7.1 0 0 0-1.7-.99L14.7 3h-5.4l-.5 2.65a7.1 7.1 0 0 0-1.7.99l-2.46-.61-2 3.46L4.2 11c-.04.32-.06.65-.06.98 0 .33.02.66.06.98l-2.02 1.53 2 3.46 2.46-.61a7.1 7.1 0 0 0 1.7.99l.5 2.65h5.4l.5-2.65a7.1 7.1 0 0 0 1.7-.99l2.46.61 2-3.46L19.34 13c.04-.32.06-.65.06-.98z"></path></svg></div>
                    Generar Embed
                </button>
                    <!-- Embed removed: embed functionality deleted -->
            </div>

            <button type="button" onclick="closeExportModal()" class="btn-form btn-primary-full">Cancelar</button>
        </div>
    </div>

        <!-- Embed Modal -->
    <div id="embedModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Insertar en Moodle / Web</h2>
                <button class="close-btn" type="button" aria-label="Cerrar" onclick="closeEmbedModal()">&times;</button>
            </div>
            <p style="color: #666; margin-bottom: 12px;">Genera un embed unico y copia el codigo en tu pagina.</p>
            <div class="form-group">
                <label>Creado por (opcional)</label>
                <input type="text" id="embedCreatedBy" placeholder="Ej: Coordinador de escuela" />
            </div>
            <textarea id="embedCode" style="width:100%; min-height: 160px; padding:12px; border:1px solid #dde3eb; border-radius:10px; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 13px; resize: vertical;" readonly></textarea>
            <div style="display:flex; gap:10px; margin-top:12px;">
                <button class="btn-embed" style="flex:1; justify-content:center;" onclick="generateEmbed()">Generar embed</button>
                <button class="btn-embed" style="flex:1; justify-content:center;" onclick="copyEmbedCode()">Copiar codigo</button>
                <button class="btn-form" style="flex:1; justify-content:center;" onclick="closeEmbedModal()">Cerrar</button>
            </div>
            <div id="embedStatus" style="display:none; margin-top:10px; font-size:13px; color:#2e7d32;">Codigo copiado al portapapeles</div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configuraci�n del Banner</h2>
                <button class="close-btn" type="button" aria-label="Cerrar" onclick="closeConfigModal()">&times;</button>
            </div>

            <div class="config-row">
                <div style="flex:1;">
                    <h3 style="color: #1a4d7e; margin-bottom: 12px; font-size: 16px;">Temas Predefinidos</h3>
                    <div class="theme-grid" id="themeGrid">
                <div class="theme-card" data-theme="sunset" onclick="selectThemeCard(this,'sunset')">
                    <div class="theme-swatches"><div class="theme-swatch" style="background:#ff6f00"></div><div class="theme-swatch" style="background:#ff1744"></div></div>
                    <div>
                        <div class="theme-label">Atardecer <span class="theme-sub">(Predeterminado)</span></div>
                    </div>
                </div>

                <div class="theme-card" data-theme="ocean" onclick="selectThemeCard(this,'ocean')">
                    <div class="theme-swatches"><div class="theme-swatch" style="background:#006994"></div><div class="theme-swatch" style="background:#00bcd4"></div></div>
                    <div>
                        <div class="theme-label">Oc�ano</div>
                    </div>
                </div>

                <div class="theme-card" data-theme="forest" onclick="selectThemeCard(this,'forest')">
                    <div class="theme-swatches"><div class="theme-swatch" style="background:#1b5e20"></div><div class="theme-swatch" style="background:#66bb6a"></div></div>
                    <div>
                        <div class="theme-label">Bosque</div>
                    </div>
                </div>

                <div class="theme-card" data-theme="auladigital" onclick="selectThemeCard(this,'auladigital')">
                    <div class="theme-swatches"><div class="theme-swatch" style="background:#1a4d7e"></div><div class="theme-swatch" style="background:#e53935"></div></div>
                    <div>
                        <div class="theme-label">Aula Digital</div>
                    </div>
                </div>
                    </div>
                </div>

                <div>
                    <div style="font-size:13px; color:#23445a; font-weight:700; margin-bottom:8px;">Mini preview</div>
                    <div id="configPreview" class="config-preview"><div id="previewScale" class="preview-scale"></div></div>
                </div>
            </div>

            <h3 style="color: #1a4d7e; margin-bottom: 12px; font-size: 16px; margin-top: 10px;">Colores Personalizados</h3>
            <div class="color-row">
                <div class="color-swatch-input" id="primarySwatch" onclick="document.getElementById('primaryColor').click()" style="background:#ff6f00"></div>
                <input type="color" id="primaryColor" value="#ff6f00" onchange="onPrimaryColorChange(this.value)" style="display:none;" />
                <input class="color-hex-input" id="primaryHex" value="#ff6f00" onchange="onPrimaryHexChange(this.value)" />
            </div>

            <div class="color-row">
                <div class="color-swatch-input" id="accentSwatch" onclick="document.getElementById('accentColor').click()" style="background:#ff1744"></div>
                <input type="color" id="accentColor" value="#ff1744" onchange="onAccentColorChange(this.value)" style="display:none;" />
                <input class="color-hex-input" id="accentHex" value="#ff1744" onchange="onAccentHexChange(this.value)" />
            </div>

            <div style="margin-top:14px;">
                <button type="button" class="apply-btn" onclick="applyConfigChanges()">Aplicar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Versions Modal -->
    <div id="versionsModal" class="modal">
        <div class="modal-content versions-modal-content">
            <div class="modal-header">
                <h2>Historial de Banners</h2>
                <button class="close-btn" type="button" aria-label="Cerrar" onclick="closeVersionsModal()">&times;</button>
            </div>

            <div class="form-group versions-save">
                <label>Guardar versi&oacute;n actual como:</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="versionName" placeholder="Ej: Banner v1 - Octubre" style="flex: 1;" />
                    <button class="btn-form" onclick="saveVersion()" style="width: auto;">Guardar</button>
                </div>
            </div>

            <h3 class="versions-title">Versiones Guardadas</h3>
            <div class="versions-list" id="versionsList">
                <p style="color: #999; text-align: center;">No hay versiones guardadas a&uacute;n.</p>
            </div>

            <div class="version-rename" id="versionRenameBox">
                <h4>Renombrar versi&oacute;n</h4>
                <input type="text" id="renameVersionInput" placeholder="Nuevo nombre..." />
                <div class="actions">
                    <button class="version-btn delete" type="button" onclick="cancelRenameVersion()">Cancelar</button>
                    <button class="version-btn" type="button" id="renameVersionSave" onclick="renameVersion()">Guardar</button>
                </div>
            </div>

            <button type="button" onclick="closeVersionsModal()" class="btn-form btn-primary-full" style="margin-top: 20px;">Cerrar</button>
        </div>
    </div>

    <script>
        // Global error handlers to capture and report JS errors (helps debugging)
        window.addEventListener('error', function (e) {
            console.error('Global error caught:', e.message, 'at', e.filename + ':' + e.lineno);
            try { alert('Error JavaScript: ' + e.message + ' Archivo: ' + e.filename + ':' + e.lineno); } catch (err) {}
        });
        window.addEventListener('unhandledrejection', function (e) {
            console.error('Unhandled promise rejection:', e.reason);
            try { alert('Error (promise): ' + (e.reason && e.reason.message ? e.reason.message : String(e.reason))); } catch (err) {}
        });
        const SCHOOL_LABELS = {
            'Educacion': 'Escuela de Educaci�n',
            'ciencia-tecnologia': 'Escuela de Ciencia y Tecnolog�a',
            'humanidades': 'Escuela de Humanidades',
            'negocios': 'Escuela de Negocios',
            'salud': 'Escuela de Salud',
            'artes': 'Escuela de Artes'
        };

        const THEMES = {
            'auladigital': { primary: '#1a4d7e', accent: '#e53935' },
            'ocean': { primary: '#006994', accent: '#00bcd4' },
            'forest': { primary: '#1b5e20', accent: '#66bb6a' },
            'sunset': { primary: '#ff6f00', accent: '#ff1744' }
        };

        // MODO DE EJECUCION (config / preview / view)
        const params = new URLSearchParams(window.location.search);
        const REQUESTED_MODE = params.get("mode") || "config";
        const STANDBY_MODE = params.get("standby") === "1";
        const MODE = STANDBY_MODE ? "view" : REQUESTED_MODE;
        const CONTEXT_ID = params.get("contextId") || '';
        const EMBED_MODE = Boolean(CONTEXT_ID);

        function createMemoryStorage() {
            const memory = {};
            return {
                getItem: (k) => Object.prototype.hasOwnProperty.call(memory, k) ? memory[k] : null,
                setItem: (k, v) => { memory[k] = String(v); },
                removeItem: (k) => { delete memory[k]; }
            };
        }

        // Safe storage wrapper: use real localStorage if available, fallback to in-memory to avoid sandbox errors
        const STORAGE = (() => {
            if (EMBED_MODE) return createMemoryStorage();
            try {
                const testKey = '__storage_test__';
                window.localStorage.setItem(testKey, '1');
                window.localStorage.removeItem(testKey);
                return window.localStorage;
            } catch (e) {
                return createMemoryStorage();
            }
        })();

        let currentDeviceSize = 'mobile';

        const SUPABASE_URL = 'https://zvsxqtohahpabhwlmnnx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_De-ddtmdrdZY82DNuymR3Q_kNFEkWlP';
        const SUPABASE_ENABLED = Boolean(SUPABASE_URL && SUPABASE_KEY);
        const SUPABASE_BUCKET = 'fotos-banners';
        const SUPABASE_REQUEST_TIMEOUT_MS = 8000;
        const VIEW_IDLE_STOP_MS = 6000;

        function fetchWithTimeout(url, options = {}) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), SUPABASE_REQUEST_TIMEOUT_MS);
            const opts = Object.assign({}, options, { signal: controller.signal });
            return fetch(url, opts).finally(() => clearTimeout(timeoutId));
        }
        const SUPABASE_CLIENT = SUPABASE_ENABLED
            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { global: { fetch: fetchWithTimeout } })
            : null;
        const EMBED_CONTEXT_TABLE = 'facilitador_contextos';
        const EMBED_HISTORY_TABLE = 'banners_historial';
        if (SUPABASE_CLIENT) {
            console.log('[v0] Supabase inicializado correctamente');
        } else {
            console.warn('[v0] Supabase deshabilitado: faltan credenciales');
        }

        function setDbStatus(state, text) {
            const status = document.getElementById('dbStatus');
            if (!status) return;
            status.classList.remove('ok', 'error', 'warn');
            status.classList.add(state);
            const label = status.querySelector('.text');
            if (label) label.textContent = text;
        }

        async function checkSupabaseConnection() {
            if (!SUPABASE_CLIENT) {
                setDbStatus('error', 'Base de datos: deshabilitada');
                return;
            }
            setDbStatus('warn', 'Base de datos: verificando...');
            const { error } = await SUPABASE_CLIENT
                .from('banners')
                .select('id', { head: true, count: 'exact' })
                .limit(1);

            if (error) {
                console.warn('[v0] Supabase sin conexion', error);
                setDbStatus('error', 'Base de datos: sin conexion');
                try { showToast('Sin conexi�n a Supabase. Revisa tu Internet o bloqueos DNS.', 'error'); } catch(e) {}
            } else {
                setDbStatus('ok', 'Base de datos: conectada');
            }
        }

        function hydrateUI(data = {}, theme = {}) {
            // Set default theme to "sunset" if none stored
            let themeConfig = theme && theme.primaryColor && theme.accentColor
                ? theme
                : JSON.parse(STORAGE.getItem('themeConfig') || '{}');
            if (!themeConfig.primaryColor || !themeConfig.accentColor) {
                themeConfig = { primaryColor: THEMES['sunset'].primary, accentColor: THEMES['sunset'].accent };
            }
            STORAGE.setItem('themeConfig', JSON.stringify(themeConfig));
            STORAGE.setItem('bannerData', JSON.stringify(data));

            if (data.name) document.getElementById('name').value = data.name;
            if (data.school) document.getElementById('school').value = data.school;
            if (data.email) document.getElementById('email').value = data.email;
            if (data.phone) document.getElementById('phone').value = data.phone;
            if (data.cedula) document.getElementById('cedula').value = data.cedula;
            if (data.whatsappPersonal) document.getElementById('whatsappPersonal').value = data.whatsappPersonal;
            if (data.whatsappGroup) document.getElementById('whatsappGroup').value = data.whatsappGroup;
            if (data.comments) document.getElementById('comments').value = data.comments;

                        if (data.photo) {
                const photoPreview = document.getElementById('photoPreview');
                const photoWrapper = document.getElementById('photoWrapper');
                const photoInputStatus = document.getElementById('photoInputStatus');
                photoPreview.src = data.photo;
                photoWrapper.style.display = 'inline-block';
                photoInputStatus.textContent = 'Foto cargada';
                photoInputStatus.classList.add('has-file');
            } else {
                const photoPreview = document.getElementById('photoPreview');
                const photoWrapper = document.getElementById('photoWrapper');
                const photoInputStatus = document.getElementById('photoInputStatus');
                if (photoPreview) photoPreview.src = '';
                if (photoWrapper) photoWrapper.style.display = 'none';
                if (photoInputStatus) {
                    photoInputStatus.textContent = 'Ning�n archivo seleccionado';
                    photoInputStatus.classList.remove('has-file');
                }
            }

            if (themeConfig.primaryColor) document.getElementById('primaryColor').value = themeConfig.primaryColor;
            if (themeConfig.accentColor) document.getElementById('accentColor').value = themeConfig.accentColor;
            if (document.getElementById('primarySwatch')) document.getElementById('primarySwatch').style.background = document.getElementById('primaryColor').value;
            if (document.getElementById('accentSwatch')) document.getElementById('accentSwatch').style.background = document.getElementById('accentColor').value;
            if (document.getElementById('primaryHex')) document.getElementById('primaryHex').value = document.getElementById('primaryColor').value;
            if (document.getElementById('accentHex')) document.getElementById('accentHex').value = document.getElementById('accentColor').value;

            if (!EMBED_MODE) {
                loadVersionsList();
            }
            updateBanner();
            try{ updateConfigPreview(); }catch(e){}
            
        }

        async function fetchBannerFromSupabase() {
            if (!SUPABASE_CLIENT) return null;
            const storedId = STORAGE.getItem('bannerId');
            let query;
            if (storedId) {
                query = SUPABASE_CLIENT.from('banners').select('*').eq('id', storedId).limit(1);
            } else {
                query = SUPABASE_CLIENT.from('banners').select('*').order('created_at', { ascending: false }).limit(1);
            }

            const { data, error } = await query;
            if (error) {
                console.warn('Supabase fetch error', error.message);
                return null;
            }

            const row = Array.isArray(data) ? data[0] : data;
            if (!row) return null;
            await clearAdditionalInfoIfWhatsApp(row);
            const historyFields = await fetchLatestHistoryFields({ bannerId: row.id, cedula: row.cedula });

            const mapped = {
                name: row.nombre || '',
                school: row.escuela || '',
                email: row.email || '',
                phone: row.telefono || '',
                cedula: row.cedula || '',
                whatsappPersonal: row.whatsapp || '',
                whatsappGroup: historyFields?.whatsappGroup ?? (row.grupo_whatsapp || ''),
                comments: historyFields?.comments ?? sanitizeAdditionalInfo(row.informacion_adicional, row),
                photo: row.foto_url || ''
            };

            const theme = {
                primaryColor: row.color_primario || THEMES['sunset'].primary,
                accentColor: row.color_secundario || THEMES['sunset'].accent
            };

            STORAGE.setItem('bannerId', row.id);
            hydrateUI(mapped, theme);
            STORAGE.setItem('historySnapshot', JSON.stringify({ data: mapped, theme }));
            return { mapped, theme };
        }

        async function fetchEmbedContext() {
            if (!SUPABASE_CLIENT || !CONTEXT_ID) return null;
            const { data, error } = await SUPABASE_CLIENT
                .from(EMBED_CONTEXT_TABLE)
                .select('*')
                .eq('context_id', CONTEXT_ID)
                .limit(1);
            if (error) {
                console.warn('Supabase embed context fetch error', error.message);
                return null;
            }
            const row = Array.isArray(data) ? data[0] : data;
            return row || null;
        }

        async function fetchActiveEmbedVersion(contextRow) {
            if (!SUPABASE_CLIENT || !CONTEXT_ID) return null;
            let query;
            if (contextRow && contextRow.active_version_id) {
                query = SUPABASE_CLIENT
                    .from(EMBED_HISTORY_TABLE)
                    .select('*')
                    .eq('id', contextRow.active_version_id)
                    .limit(1);
            } else {
                query = SUPABASE_CLIENT
                    .from(EMBED_HISTORY_TABLE)
                    .select('*')
                    .eq('context_id', CONTEXT_ID)
                    .order('created_at', { ascending: false })
                    .limit(1);
            }
            const { data, error } = await query;
            if (error) {
                console.warn('Supabase embed version fetch error', error.message);
                return null;
            }
            const row = Array.isArray(data) ? data[0] : data;
            return row || null;
        }

        function setEmptyEmbedState() {
            const emptyData = {
                name: '',
                school: '',
                email: '',
                phone: '',
                cedula: '',
                whatsappPersonal: '',
                whatsappGroup: '',
                comments: '',
                photo: ''
            };
            const theme = {
                primaryColor: THEMES['sunset'].primary,
                accentColor: THEMES['sunset'].accent
            };
            hydrateUI(emptyData, theme);
        }

        function stopPendingLoadInView() {
            if (MODE !== 'view' && !STANDBY_MODE) return;
            try { window.stop(); } catch (e) {}
        }

        function armViewIdleStop() {
            if (MODE !== 'view' && !STANDBY_MODE) return;
            const timerId = setTimeout(() => {
                stopPendingLoadInView();
            }, VIEW_IDLE_STOP_MS);
            window.addEventListener('load', () => {
                stopPendingLoadInView();
                clearTimeout(timerId);
            }, { once: true });
        }

        async function loadEmbedContext() {
            if (!SUPABASE_CLIENT) {
                setEmptyEmbedState();
                stopPendingLoadInView();
                return;
            }
            const contextRow = await fetchEmbedContext();
            if (!contextRow || contextRow.status === 'empty') {
                setEmptyEmbedState();
                stopPendingLoadInView();
                return;
            }
            const versionRow = await fetchActiveEmbedVersion(contextRow);
            if (!versionRow) {
                setEmptyEmbedState();
                stopPendingLoadInView();
                return;
            }
            const mapped = {
                name: versionRow.nombre || '',
                school: versionRow.escuela || '',
                email: versionRow.email || '',
                phone: versionRow.telefono || '',
                cedula: versionRow.cedula || '',
                whatsappPersonal: versionRow.whatsapp || '',
                whatsappGroup: versionRow.grupo_whatsapp || '',
                comments: sanitizeAdditionalInfo(versionRow.informacion_adicional, versionRow),
                photo: versionRow.foto_url || ''
            };
            const theme = {
                primaryColor: versionRow.color_primario || THEMES['sunset'].primary,
                accentColor: versionRow.color_secundario || THEMES['sunset'].accent
            };
            hydrateUI(mapped, theme);
            stopPendingLoadInView();
        }

        async function syncToSupabase(data, theme) {
            if (!SUPABASE_CLIENT) return false;
            const bannerId = STORAGE.getItem('bannerId');
            const payload = {
                nombre: data.name || null,
                escuela: data.school || null,
                email: data.email || null,
                telefono: data.phone || null,
                cedula: data.cedula || null,
                whatsapp: data.whatsappPersonal || null,
                // Estos dos campos se manejan solo en la tabla automatica (historial)
                grupo_whatsapp: null,
                informacion_adicional: null,
                foto_url: data.photo || null,
                color_primario: theme.primaryColor || null,
                color_secundario: theme.accentColor || null
            };

            let response;
            if (bannerId) {
                console.log('[v0] Supabase update ->', { id: bannerId, payload });
                response = await SUPABASE_CLIENT
                    .from('banners')
                    .update(payload)
                    .eq('id', bannerId)
                    .select()
                    .limit(1);
            } else {
                console.log('[v0] Supabase insert ->', { payload });
                response = await SUPABASE_CLIENT
                    .from('banners')
                    .insert(payload)
                    .select()
                    .limit(1);
            }

            const { data: upserted, error } = response;
            console.log('[v0] Supabase response ->', { data: upserted, error });

            if (error) {
                console.warn('Supabase sync error', error.message);
                return false;
            }

            const row = Array.isArray(upserted) ? upserted[0] : upserted;
            if (row && row.id) STORAGE.setItem('bannerId', row.id);
            return true;
        }

        async function saveEmbedVersion(data, theme) {
            if (!SUPABASE_CLIENT || !CONTEXT_ID) return false;
            const versionName = `Contexto ${CONTEXT_ID} - ${new Date().toLocaleString('es-ES')}`;
            const payload = {
                context_id: CONTEXT_ID,
                banner_id: null,
                version_name: versionName,
                nombre: data.name || null,
                escuela: data.school || null,
                email: data.email || null,
                telefono: data.phone || null,
                cedula: data.cedula || null,
                whatsapp: data.whatsappPersonal || null,
                grupo_whatsapp: data.whatsappGroup || null,
                informacion_adicional: data.comments || null,
                foto_url: data.photo || null,
                color_primario: theme.primaryColor || null,
                color_secundario: theme.accentColor || null,
                created_at: new Date().toISOString()
            };

            const { data: inserted, error } = await SUPABASE_CLIENT
                .from(EMBED_HISTORY_TABLE)
                .insert(payload)
                .select()
                .limit(1);
            if (error) {
                console.warn('Supabase embed save error', error.message);
                return false;
            }

            const row = Array.isArray(inserted) ? inserted[0] : inserted;
            const updatePayload = {
                status: 'configured',
                updated_at: new Date().toISOString()
            };
            if (row && row.id) updatePayload.active_version_id = row.id;

            const { error: contextError } = await SUPABASE_CLIENT
                .from(EMBED_CONTEXT_TABLE)
                .update(updatePayload)
                .eq('context_id', CONTEXT_ID);
            if (contextError) {
                console.warn('Supabase embed context update error', contextError.message);
            }
            return true;
        }

        // Drag & Drop
        async function loadData() {
            const data = JSON.parse(STORAGE.getItem('bannerData') || '{}');
            const theme = JSON.parse(STORAGE.getItem('themeConfig') || '{}');
            hydrateUI(data, theme);
            armViewIdleStop();

            if (SUPABASE_CLIENT) {
                try {
                    if (MODE !== "view") {
                        await checkSupabaseConnection();
                    }
                    if (EMBED_MODE) {
                        await loadEmbedContext();
                    } else {
                        const skipAutoload = STORAGE.getItem('skipAutoload') === '1';
                        if (!skipAutoload) {
                            await fetchBannerFromSupabase();
                        }
                        stopPendingLoadInView();
                    }
                } catch (e) {
                    console.warn('No se pudo sincronizar con Supabase en el arranque', e);
                }
            } else if (EMBED_MODE) {
                setEmptyEmbedState();
            }
        }

        async function saveData() {
            console.log('[v0] saveData called');
            showSaveStatus();
            STORAGE.removeItem('skipAutoload');
            const photoPreview = document.getElementById('photoPreview');
            const cedulaRaw = document.getElementById('cedula').value.trim();

            const data = {
                name: document.getElementById('name').value.trim(),
                school: document.getElementById('school').value,
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                cedula: formatCedula(cedulaRaw) || cedulaRaw,
                whatsappPersonal: document.getElementById('whatsappPersonal').value.trim(),
                whatsappGroup: document.getElementById('whatsappGroup').value.trim(),
                comments: document.getElementById('comments').value,
                photo: photoPreview && photoPreview.src ? photoPreview.src : ''
            };
            STORAGE.setItem('bannerData', JSON.stringify(data));
            updateBanner();
            try{ updateConfigPreview(); }catch(e){}

            const theme = JSON.parse(STORAGE.getItem('themeConfig') || '{}');
            let syncOk = true;
            if (EMBED_MODE) {
                syncOk = await saveEmbedVersion(data, theme);
            } else if (SUPABASE_CLIENT) {
                syncOk = await syncToSupabase(data, theme);
            }

            // ENVIAR CAMBIOS EN TIEMPO REAL AL CONTENEDOR
            if (!EMBED_MODE) {
                try {
                    window.parent.postMessage({
                        type: "BANNER_UPDATE",
                        payload: {
                            data: JSON.parse(STORAGE.getItem('bannerData') || '{}'),
                            theme: JSON.parse(STORAGE.getItem('themeConfig') || '{}')
                        }
                    }, "*");
                } catch (e) {}
            }
            if (syncOk && !EMBED_MODE) {
                await saveHistoryVersionIfChanged(data, theme);
            }
            showToast('Formulario guardado correctamente', 'success');
        }

        function handlePhotoUpload() {
            const input = document.getElementById('photo');
            const file = input.files[0];
            const photoPreview = document.getElementById('photoPreview');
            const photoWrapper = document.getElementById('photoWrapper');
            const photoInputStatus = document.getElementById('photoInputStatus');
            const photoError = document.getElementById('photoError');

            photoError.textContent = '';

            if (!file) return;

            if (!file.type.startsWith('image/')) {
                photoError.textContent = 'El archivo debe ser una imagen.';
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                photoError.textContent = 'La imagen no debe superar 5MB.';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    photoPreview.src = e.target.result;
                    photoWrapper.style.display = 'inline-block';
                    photoInputStatus.textContent = 'Foto cargada: ' + file.name;
                    photoInputStatus.classList.add('has-file');
                };
                img.onerror = () => {
                    photoError.textContent = 'El archivo no es una imagen valida.';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removePhoto() {
            const photoPreview = document.getElementById('photoPreview');
            const photoWrapper = document.getElementById('photoWrapper');
            const photoInput = document.getElementById('photo');
            const photoInputStatus = document.getElementById('photoInputStatus');

            photoInput.value = '';
            photoPreview.src = '';
            photoWrapper.style.display = 'none';
            photoInputStatus.textContent = 'Ning�n archivo seleccionado';
            photoInputStatus.classList.remove('has-file');
            saveData();
        }

        function saveTheme() {
            showSaveStatus();
            const theme = {
                primaryColor: document.getElementById('primaryColor').value,
                accentColor: document.getElementById('accentColor').value
            };
            STORAGE.setItem('themeConfig', JSON.stringify(theme));
            updateBanner();

            if (SUPABASE_CLIENT && !EMBED_MODE) {
                const data = JSON.parse(STORAGE.getItem('bannerData') || '{}');
                syncToSupabase(data, theme).catch(err => console.warn('Supabase sync error', err));
            }
        }

        function applyTheme(themeName) {
            const theme = THEMES[themeName];
            if (theme) {
                document.getElementById('primaryColor').value = theme.primary;
                document.getElementById('accentColor').value = theme.accent;

                // update swatches/inputs if present
                try {
                    document.getElementById('primarySwatch').style.background = theme.primary;
                    document.getElementById('accentSwatch').style.background = theme.accent;
                    if (document.getElementById('primaryHex')) document.getElementById('primaryHex').value = theme.primary;
                    if (document.getElementById('accentHex')) document.getElementById('accentHex').value = theme.accent;
                } catch(e){}

                document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
                try { event.currentTarget && event.currentTarget.classList.add('active'); } catch(e){}

                saveTheme();
            }
        }

        function selectThemeCard(el, themeName) {
            document.querySelectorAll('.theme-card').forEach(c=>c.classList.remove('active'));
            el.classList.add('active');
            applyTheme(themeName);
        }

        function onPrimaryColorChange(val) { document.getElementById('primarySwatch').style.background = val; if(document.getElementById('primaryHex')) document.getElementById('primaryHex').value = val; saveTheme(); }
        function onAccentColorChange(val) { document.getElementById('accentSwatch').style.background = val; if(document.getElementById('accentHex')) document.getElementById('accentHex').value = val; saveTheme(); }
        function onPrimaryHexChange(val) { try{ document.getElementById('primarySwatch').style.background = val; document.getElementById('primaryColor').value = val; saveTheme(); }catch(e){} }
        function onAccentHexChange(val) { try{ document.getElementById('accentSwatch').style.background = val; document.getElementById('accentColor').value = val; saveTheme(); }catch(e){} }

        function applyConfigChanges(){ saveTheme(); closeConfigModal(); }

        async function generateQrDataUrl(text, size = 200) {
            const value = (text || '').trim();
            if (!value) return '';
            const fallback = `https://chart.googleapis.com/chart?cht=qr&chs=${size}x${size}&chl=${encodeURIComponent(value)}`;

            // 1) qrcode-generator (Arase)
            if (typeof qrcode === 'function') {
                try {
                    const qr = qrcode(0, 'H');
                    qr.addData(value);
                    qr.make();
                    const cellSize = Math.max(2, Math.floor(size / 40));
                    return qr.createDataURL(cellSize, 2); // margen peque�o
                } catch (e) {
                    console.error('Error al generar el QR con qrcode-generator', e);
                }
            }

            // 2) QRCode (node-qrcode browser build)
            if (window.QRCode && typeof QRCode.toDataURL === 'function') {
                try {
                    return await QRCode.toDataURL(value, { width: size, margin: 1 });
                } catch (e) {
                    console.error('Error al generar el QR con QRCode', e);
                }
            }

            // 3) QRious (local vendored)
            if (window.QRious) {
                try {
                    const qr = new QRious({ value, size, level: 'H' });
                    if (typeof qr.toDataURL === 'function') return qr.toDataURL();
                } catch (e) {
                    console.error('Error al generar el QR con QRious', e);
                }
            }

            // 4) External fallback
            return fallback;
        }

        function updateConfigPreview(){
            try{
                const banner = document.getElementById('bannerPreview');
                const previewScale = document.getElementById('previewScale');
                if(!banner || !previewScale) return;
                // copy innerHTML and background
                previewScale.innerHTML = banner.innerHTML;
                previewScale.style.background = banner.style.background || '';
            }catch(e){ console.error('updateConfigPreview error', e); }
        }

        // Device selection removed - always show desktop preview

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatMultiline(value) {
            return escapeHtml(value).replace(/\n/g, '<br>');
        }

        function sanitizeUrl(value) {
            if (!value) return '';
            try {
                const url = new URL(value, window.location.href);
                return (url.protocol === 'http:' || url.protocol === 'https:') ? url.href : '';
            } catch (e) {
                return '';
            }
        }

        function formatEmbedCode(contextId) {
            const baseUrl = 'https://edgarcastillo083dv.github.io/Banner_Docente/';
            const configSrc = `${baseUrl}?mode=config&contextId=${encodeURIComponent(contextId)}`;
            const viewSrc = `${baseUrl}?mode=view&contextId=${encodeURIComponent(contextId)}`;
            return [
                `Embed de Configuracion:`,
                `<iframe src="${configSrc}" width="100%" height="650" style="border:0; overflow:hidden;" loading="lazy"></iframe>`,
                '',
                `Embed de Vista (solo lectura):`,
                `<iframe src="${viewSrc}" width="900" height="450" style="border:0; overflow:hidden;" loading="lazy"></iframe>`
            ].join('\n');
        }

        async function createEmbedContext(contextId, createdBy) {
            if (!SUPABASE_CLIENT) return { ok: false, error: 'Base de datos deshabilitada.' };
            const payload = {
                context_id: contextId,
                status: 'empty',
                created_at: new Date().toISOString(),
                created_by: createdBy || null
            };
            const { error } = await SUPABASE_CLIENT
                .from(EMBED_CONTEXT_TABLE)
                .insert(payload)
                .select()
                .limit(1);
            if (error) {
                console.warn('Supabase embed context error', error.message);
                return { ok: false, error: error.message };
            }
            return { ok: true };
        }

        async function generateEmbed() {
            const contextId = crypto.randomUUID();
            const createdByInput = document.getElementById('embedCreatedBy');
            const createdBy = createdByInput && createdByInput.value.trim()
                ? createdByInput.value.trim()
                : null;
            const created = await createEmbedContext(contextId, createdBy);
            if (!created.ok) {
                showToast('No se pudo generar el embed.', 'error');
                return;
            }
            const textarea = document.getElementById('embedCode');
            if (textarea) textarea.value = formatEmbedCode(contextId);
            showToast('Embed generado', 'success');
        }

        function openEmbedGenerator() {
            const textarea = document.getElementById('embedCode');
            if (textarea) textarea.value = '';
            const createdByInput = document.getElementById('embedCreatedBy');
            if (createdByInput) createdByInput.value = '';
            document.getElementById('embedModal').classList.add('active');
        }

        function isWhatsAppAdditionalInfo(info, row) {
            const text = String(info || '').trim();
            if (!text) return false;
            const personal = String(row?.whatsapp || '').trim();
            const group = String(row?.grupo_whatsapp || '').trim();
            if (personal && text === personal) return true;
            if (group && text === group) return true;
            return false;
        }

        function sanitizeAdditionalInfo(info, row) {
            return isWhatsAppAdditionalInfo(info, row) ? '' : String(info || '').trim();
        }

        async function clearAdditionalInfoIfWhatsApp(row) {
            if (!SUPABASE_CLIENT || !row || !row.id) return;
            if (!isWhatsAppAdditionalInfo(row.informacion_adicional, row)) return;
            const { error } = await SUPABASE_CLIENT
                .from('banners')
                .update({ informacion_adicional: null })
                .eq('id', row.id);
            if (error) {
                console.warn('Supabase update error', error.message);
            }
        }

        async function fetchLatestHistoryFields(filter) {
            if (!SUPABASE_CLIENT || (!filter?.bannerId && !filter?.cedula)) return null;

            let query = SUPABASE_CLIENT
                .from(EMBED_HISTORY_TABLE)
                .select('grupo_whatsapp, informacion_adicional, whatsapp')
                .order('created_at', { ascending: false })
                .limit(1)
                .is('context_id', null);

            if (filter.bannerId) {
                query = query.eq('banner_id', filter.bannerId);
            } else if (filter.cedula) {
                query = query.eq('cedula', filter.cedula);
            }

            const { data, error } = await query;
            if (error) {
                console.warn('Supabase history fetch error', error.message);
                return null;
            }
            const row = Array.isArray(data) ? data[0] : data;
            if (!row) return null;

            return {
                whatsappGroup: row.grupo_whatsapp || '',
                comments: sanitizeAdditionalInfo(row.informacion_adicional, row)
            };
        }

        function safeOpen(url) {
            const safeUrl = sanitizeUrl(url);
            if (!safeUrl) return;
            const win = window.open(safeUrl, '_blank', 'noopener,noreferrer');
            if (win) win.opener = null;
        }

        async function updateBanner() {
            const data = JSON.parse(STORAGE.getItem('bannerData') || '{}');
            const theme = JSON.parse(STORAGE.getItem('themeConfig') || '{}');
            const primaryColor = theme.primaryColor || THEMES['sunset'].primary;
            const accentColor = theme.accentColor || THEMES['sunset'].accent;
            const whatsappPersonalNumber = (data.whatsappPersonal || '').replace(/[^0-9]/g, '');
            const whatsappPersonalUrl = whatsappPersonalNumber ? `https://wa.me/${whatsappPersonalNumber}` : '';
            const whatsappGroupUrl = sanitizeUrl(data.whatsappGroup);
            const qrImage = whatsappGroupUrl ? await generateQrDataUrl(whatsappGroupUrl, 200) : '';

            // marcar tarjeta activa seg�n colores actuales
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            if (primaryColor === THEMES['sunset'].primary && accentColor === THEMES['sunset'].accent) {
                const card = document.querySelector('.theme-card[data-theme=\"sunset\"]');
                if (card) card.classList.add('active');
            }

            const initial = data.name ? data.name.charAt(0).toUpperCase() : '?';
            const safeInitial = escapeHtml(initial);

            const hasRequiredFields =
                data.name &&
                data.school &&
                data.email &&
                data.phone &&
                data.cedula &&
                data.whatsappPersonal &&
                data.whatsappGroup;

            const banner = document.getElementById('bannerPreview');
            if (!hasRequiredFields) {
                const emptyMessage = EMBED_MODE
                    ? '<div class="empty-state"><p>Este banner a\u00fan no ha sido configurado</p></div>'
                    : '<div class="empty-state"><p>El Facilitador no ha actualizado</p><p>Debe contactar con Encargado de Escuela</p></div>';
                banner.innerHTML = emptyMessage;
                banner.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
                return;
            }

            const schoolLabel = SCHOOL_LABELS[data.school] || 'Facilitador Docente';
            const safeName = escapeHtml(data.name || '');
            const safeSchoolLabel = escapeHtml(schoolLabel);
            const safeEmail = escapeHtml(data.email || '');
            const safePhoneText = escapeHtml(data.phone || '');
            const phoneForLink = (data.phone || '').replace(/[^0-9+]/g, '');
            const phoneHref = phoneForLink ? `tel:${phoneForLink}` : '#';
            const emailHref = data.email ? `mailto:${encodeURIComponent(data.email)}` : '#';
            const safePhoto = escapeHtml(data.photo || '');
            const hasComments = Boolean(data.comments && data.comments.trim());
            const safeComments = hasComments ? formatMultiline(data.comments) : '';

                        banner.innerHTML = `
                <div class="banner-content">
                    <div class="banner-header">
                        <div style="display:flex; align-items:center; gap:16px;">
                            <div class="banner-photo-wrapper">
                                ${
                                    data.photo
                                        ? `<img src="${safePhoto}" alt="${safeName}" class="banner-photo" />`
                                        : `<div class="banner-photo-placeholder">${safeInitial}</div>`
                                }
                                <span class="status-dot" title="Activo"></span>
                            </div>
                            <div>
                                <div class="banner-title">${safeName}</div>
                                <div class="banner-school">${safeSchoolLabel}</div>
                            </div>
                        </div>
                        <img class="banner-logo" src="./recursos/img/logo-blanco-uapa.png" alt="Logo UAPA" loading="lazy" />
                    </div>

                    <div class="banner-contact">
                        <div class="contact-item">
                            <svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1z"></path><path d="m4 7 8 5 8-5"></path></svg>
                            <a href="${emailHref}" style="color: white; text-decoration: none;">${safeEmail}</a>
                        </div>
                        <div class="contact-item">
                            <svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M6.5 3h2.7c.2 0 .4.15.45.35l.7 3a.5.5 0 0 1-.14.47L8.6 8.87a9.5 9.5 0 0 0 6.53 6.53l1.05-1.61a.5.5 0 0 1 .47-.14l3 .7c.2.05.35.25.35.46v2.7a1 1 0 0 1-1 1A12.5 12.5 0 0 1 5.5 4a1 1 0 0 1 1-1z"></path></svg>
                            <a href="${phoneHref}" style="color: white; text-decoration: none;">${safePhoneText}</a>
                        </div>
                        <button class="banner-button whatsapp-personal" onclick="safeOpen('${whatsappPersonalUrl}')">
                            Chat Personal
                            <svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a9 9 0 0 0-7.8 13.5L3 21l4.7-1.2A9 9 0 1 0 12 3Z" fill="none"></path><path d="M9.5 8.8c.2-.3.3-.5.5-.5.1 0 .3-.1.5.1.1.1.9 1 .9 1.1 0 .1.1.3 0 .5-.2.2-.3.3-.5.5-.1.1-.3.2-.2.4.1.2.5.9 1.2 1.5.8.6 1.4.8 1.6.9.1.1.3 0 .4-.1s.5-.6.7-.8.3-.1.5-.1.3 0 .4 0 .4.2.4.3.4 1.1.4 1.3-.1.3-.3.4c-.1.1-.7.4-1.4.4-.3 0-.9-.1-1.6-.4-.9-.3-1.8-1-2.5-1.8-.3-.4-.8-1-1-1.6-.4-.8-.3-1.4-.2-1.5z" fill="none"></path></svg>
                        </button>
                        <button class="banner-button whatsapp-group" onclick="safeOpen('${whatsappGroupUrl}')">
                            Unirse al Grupo
                            <svg class="icon" aria-hidden="true" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a9 9 0 0 0-7.8 13.5L3 21l4.7-1.2A9 9 0 1 0 12 3Z" fill="none"></path><path d="M9.5 8.8c.2-.3.3-.5.5-.5.1 0 .3-.1.5.1.1.1.9 1 .9 1.1 0 .1.1.3 0 .5-.2.2-.3.3-.5.5-.1.1-.3.2-.2.4.1.2.5.9 1.2 1.5.8.6 1.4.8 1.6.9.1.1.3 0 .4-.1s.5-.6.7-.8.3-.1.5-.1.3 0 .4 0 .4.2.4.3.4 1.1.4 1.3-.1.3-.3.4c-.1.1-.7.4-1.4.4-.3 0-.9-.1-1.6-.4-.9-.3-1.8-1-2.5-1.8-.3-.4-.8-1-1-1.6-.4-.8-.3-1.4-.2-1.5z" fill="none"></path></svg>
                        </button>
                    </div>

                                        ${
                        hasComments || qrImage
                            ? `
                        <div class="banner-additional">
                            <div class="banner-extra-row">
                                <div class="banner-extra-text">
                                    ${hasComments ? `<h4>Informaci�n Adicional</h4><p>${safeComments}</p>` : `<h4>Grupo de WhatsApp</h4><p>Escanea el c�digo para unirte al grupo.</p>`}
                                </div>
                                ${qrImage ? `<div class="banner-qr"><img src="${qrImage}" alt="QR del grupo de WhatsApp" width="96" height="96" /></div>` : ''}
                            </div>
                        </div>
                    `
                            : ''
                    }
                </div>
            `;

            banner.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${accentColor} 100%)`;
            // Embed functionality removed
        }

        function validateForm() {
            let isValid = true;
            const missing = [];

            const name = document.getElementById('name').value.trim();
            const school = document.getElementById('school').value;
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const cedula = document.getElementById('cedula').value.trim();
            const photoPreview = document.getElementById('photoPreview');
            const whatsappPersonal = document.getElementById('whatsappPersonal').value.trim();
            const whatsappGroup = document.getElementById('whatsappGroup').value.trim();

            const nameError = document.getElementById('nameError');
            const schoolError = document.getElementById('schoolError');
            const emailError = document.getElementById('emailError');
            const phoneError = document.getElementById('phoneError');
            const cedulaError = document.getElementById('cedulaError');
            const wpPersonalError = document.getElementById('whatsappPersonalError');
            const wpGroupError = document.getElementById('whatsappGroupError');
            const photoError = document.getElementById('photoError');

            nameError.textContent = '';
            schoolError.textContent = '';
            emailError.textContent = '';
            phoneError.textContent = '';
            cedulaError.textContent = '';
            wpPersonalError.textContent = '';
            wpGroupError.textContent = '';
            if (photoError) photoError.textContent = '';

            if (!name) {
                nameError.textContent = 'Este campo es obligatorio.';
                isValid = false;
                missing.push('name');
            }

            if (!school) {
                schoolError.textContent = 'Seleccione una escuela.';
                isValid = false;
                missing.push('school');
            }

            if (!email) {
                emailError.textContent = 'Este campo es obligatorio.';
                isValid = false;
                missing.push('email');
            } else if (!/^\S+@\S+\.\S+$/.test(email)) {
                emailError.textContent = 'Ingrese un correo v�lido.';
                isValid = false;
            }

            if (!phone) {
                phoneError.textContent = 'Este campo es obligatorio.';
                isValid = false;
                missing.push('phone');
            }

            if (!cedula) {
                cedulaError.textContent = 'Este campo es obligatorio.';
                isValid = false;
                missing.push('cedula');
            }

            if (!whatsappPersonal) {
                wpPersonalError.textContent = 'Este campo es obligatorio.';
                isValid = false;
                missing.push('whatsappPersonal');
            }

            if (!whatsappGroup) {
                wpGroupError.textContent = 'Este campo es obligatorio.';
                isValid = false;
                missing.push('whatsappGroup');
            } else if (!/^https?:\/\//i.test(whatsappGroup)) {
                wpGroupError.textContent = 'Ingrese un enlace v�lido (http o https).';
                isValid = false;
            }

            if (!isValid) {
                console.warn('[v0] Validacion fallida', missing);
            }
            return isValid;
        }

        async function submitFormModal() {
            console.log('[v0] submitFormModal');
            if (!validateForm()) {
                return;
            }
            await saveData();
            closeFormModal();
            if (!EMBED_MODE) {
                clearFormModal();
            }
        }

        async function clearFormAndClose() {
            clearFormModal();
            const emptyData = {
                name: '',
                school: '',
                email: '',
                phone: '',
                cedula: '',
                whatsappPersonal: '',
                whatsappGroup: '',
                comments: '',
                photo: ''
            };
            STORAGE.setItem('bannerData', JSON.stringify(emptyData));
            STORAGE.setItem('skipAutoload', '1');
            STORAGE.removeItem('bannerId');
            updateBanner();
            try { updateConfigPreview(); } catch (e) {}
            closeFormModal();
        }

        function clearFormModal(options = {}) {
            const keepCedula = Boolean(options.keepCedula);
            const fields = [
                'name',
                'email',
                'phone',
                'whatsappPersonal',
                'whatsappGroup',
                'comments'
            ];

            fields.forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });

            if (!keepCedula) {
                const cedula = document.getElementById('cedula');
                if (cedula) cedula.value = '';
            }

            const school = document.getElementById('school');
            if (school) school.value = '';

            const errorIds = [
                'nameError',
                'schoolError',
                'emailError',
                'phoneError',
                'cedulaError',
                'whatsappPersonalError',
                'whatsappGroupError',
                'photoError'
            ];
            errorIds.forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.textContent = '';
            });

            setCedulaStatus('', '');
            lastCedulaLookup = '';
            setFacilitatorFieldsReadOnly(false);

            const photoInput = document.getElementById('photo');
            const photoPreview = document.getElementById('photoPreview');
            const photoWrapper = document.getElementById('photoWrapper');
            const photoInputStatus = document.getElementById('photoInputStatus');

            if (photoInput) photoInput.value = '';
            if (photoPreview) photoPreview.src = '';
            if (photoWrapper) photoWrapper.style.display = 'none';
                if (photoInputStatus) {
                    photoInputStatus.textContent = 'Ning�n archivo seleccionado';
                    photoInputStatus.classList.remove('has-file');
                }
        }

        function normalizeCedula(value) {
            return String(value || '').replace(/\D/g, '');
        }

        function formatCedula(value) {
            const digits = normalizeCedula(value);
            if (digits.length !== 11) return '';
            return `${digits.slice(0, 3)}-${digits.slice(3, 10)}-${digits.slice(10)}`;
        }

        function setCedulaStatus(type, message) {
            const status = document.getElementById('cedulaStatus');
            if (!status) return;
            status.classList.remove('success', 'error');
            status.textContent = message || '';
            if (message && type) status.classList.add(type);
        }

        const FACILITATOR_FIELDS = ['name', 'school', 'email', 'phone', 'whatsappPersonal'];
        const FACILITATOR_PHOTO_IDS = ['photo', 'removePhotoBtn', 'photoInputLabel'];
        let facilitatorLocked = false;

        function updateEditFacilitatorButton() {
            const btn = document.getElementById('editFacilitatorBtn');
            if (!btn) return;
            btn.disabled = !facilitatorLocked;
        }

        function setFacilitatorFieldsReadOnly(locked) {
            facilitatorLocked = locked;
            FACILITATOR_FIELDS.forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (el.tagName === 'SELECT') {
                    el.disabled = locked;
                } else {
                    el.readOnly = locked;
                }
                el.classList.toggle('field-locked', locked);
            });
            FACILITATOR_PHOTO_IDS.forEach((id) => {
                const el = document.getElementById(id);
                if (!el) return;
                if (locked) {
                    el.setAttribute('disabled', 'disabled');
                    el.classList.add('field-locked');
                } else {
                    el.removeAttribute('disabled');
                    el.classList.remove('field-locked');
                }
            });
            const photoWrapper = document.getElementById('photoWrapper');
            if (photoWrapper) photoWrapper.classList.toggle('field-locked', locked);
            updateEditFacilitatorButton();
        }

        function enableFacilitatorEditing() {
            setFacilitatorFieldsReadOnly(false);
            showToast('Edici�n habilitada', 'success');
        }

        async function lookupCedulaAndFill(rawValue) {
            if (EMBED_MODE) return;
            const raw = String(rawValue || '').trim();
            const normalized = normalizeCedula(raw);

            if (normalized.length < 11) {
                setCedulaStatus('', '');
                setFacilitatorFieldsReadOnly(false);
                return;
            }

            if (normalized === lastCedulaLookup) return;
            lastCedulaLookup = normalized;

            if (!SUPABASE_CLIENT) {
                setCedulaStatus('error', 'Base de datos deshabilitada.');
                lastCedulaLookup = '';
                return;
            }

            setCedulaStatus('', 'Buscando c�dula...');

            const formatted = formatCedula(normalized);
            const filters = [
                `cedula.eq.${raw}`,
                `cedula.eq.${normalized}`
            ];
            if (formatted) filters.push(`cedula.eq.${formatted}`);

            const { data, error } = await SUPABASE_CLIENT
                .from('banners')
                .select('*')
                .or(filters.join(','))
                .limit(1);

            if (error) {
                console.warn('Supabase lookup error', error.message);
                setCedulaStatus('error', 'No se pudo consultar la c�dula.');
                lastCedulaLookup = '';
                return;
            }

            const row = Array.isArray(data) ? data[0] : data;
            if (!row) {
                STORAGE.removeItem('bannerId');
                clearFormModal({ keepCedula: true });
                setCedulaStatus('error', 'C�dula no encontrada. Completa los datos.');
                return;
            }
            await clearAdditionalInfoIfWhatsApp(row);
            const historyFields = await fetchLatestHistoryFields({ bannerId: row.id, cedula: row.cedula });

            const mapped = {
                name: row.nombre || '',
                school: row.escuela || '',
                email: row.email || '',
                phone: row.telefono || '',
                cedula: row.cedula || '',
                whatsappPersonal: row.whatsapp || '',
                whatsappGroup: historyFields?.whatsappGroup ?? (row.grupo_whatsapp || ''),
                comments: historyFields?.comments ?? sanitizeAdditionalInfo(row.informacion_adicional, row),
                photo: row.foto_url || ''
            };

            const theme = {
                primaryColor: row.color_primario || THEMES['sunset'].primary,
                accentColor: row.color_secundario || THEMES['sunset'].accent
            };

            STORAGE.setItem('bannerId', row.id);
            hydrateUI(mapped, theme);
            STORAGE.setItem('historySnapshot', JSON.stringify({ data: mapped, theme }));
            setFacilitatorFieldsReadOnly(true);
            setCedulaStatus('success', 'C�dula encontrada. Puedes editar los datos.');
        }

        function populateFormFromSavedData() {
            const data = JSON.parse(STORAGE.getItem('bannerData') || '{}');
            const storedId = STORAGE.getItem('lastBannerId');
            if (storedId) STORAGE.setItem('bannerId', storedId);
            setCedulaStatus('', '');
            setFacilitatorFieldsReadOnly(false);

            if (data.cedula) document.getElementById('cedula').value = data.cedula;
            if (data.name) document.getElementById('name').value = data.name;
            if (data.email) document.getElementById('email').value = data.email;
            if (data.phone) document.getElementById('phone').value = data.phone;
            if (data.whatsappPersonal) document.getElementById('whatsappPersonal').value = data.whatsappPersonal;
            if (data.whatsappGroup) document.getElementById('whatsappGroup').value = data.whatsappGroup;
            if (data.comments) document.getElementById('comments').value = data.comments;
            if (data.school) document.getElementById('school').value = data.school;

            const photoPreview = document.getElementById('photoPreview');
            const photoWrapper = document.getElementById('photoWrapper');
            const photoInputStatus = document.getElementById('photoInputStatus');

            if (data.photo) {
                photoPreview.src = data.photo;
                photoWrapper.style.display = 'inline-block';
                photoInputStatus.textContent = 'Foto cargada';
                photoInputStatus.classList.add('has-file');
            } else {
                photoPreview.src = '';
                photoWrapper.style.display = 'none';
                photoInputStatus.textContent = 'Ning�n archivo seleccionado';
                photoInputStatus.classList.remove('has-file');
            }
        }

        async function downloadBanner(format) {
            const banner = document.getElementById('bannerPreview');
            if (banner.querySelector('.empty-state')) {
                alert('Completa todos los campos obligatorios primero.');
                return;
            }

            const data = JSON.parse(STORAGE.getItem('bannerData') || '{}');
            const btn = document.activeElement;
            btn.disabled = true;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Procesando...';

            try {
                const canvas = await html2canvas(banner, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null,
                    logging: false
                });

                const safeName = (data.name || 'banner-facilitador').replace(/\s/g, '-').toLowerCase();
                const link = document.createElement('a');
                
                // Export as image formats only (PNG, JPG, WebP)
                const mimeType = format === 'jpg' ? 'image/jpeg' : format === 'webp' ? 'image/webp' : 'image/png';
                canvas.toBlob(blob => {
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    link.download = `banner-${safeName}.${format}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }, mimeType, format === 'jpg' ? 0.95 : 1);
            } catch (err) {
                console.error('Error descargando:', err);
                alert('Error al descargar el banner.');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

function getHistoryFilter() {
    const data = JSON.parse(STORAGE.getItem('bannerData') || '{}');
    const bannerId = STORAGE.getItem('bannerId') || null;
    const cedula = data.cedula ? (formatCedula(data.cedula) || data.cedula) : null;
    return { bannerId, cedula };
}

function createHistoryPayload(versionName, data, theme) {
    const bannerId = STORAGE.getItem('bannerId') || null;
    return {
        banner_id: bannerId,
        version_name: versionName,
        cedula: data.cedula || null,
        nombre: data.name || null,
        escuela: data.school || null,
        email: data.email || null,
        telefono: data.phone || null,
        whatsapp: data.whatsappPersonal || null,
        grupo_whatsapp: data.whatsappGroup || null,
        foto_url: data.photo || null,
        informacion_adicional: data.comments || null,
        color_primario: theme.primaryColor || null,
        color_secundario: theme.accentColor || null
    };
}

async function saveHistoryVersionIfChanged(data, theme) {
    if (!SUPABASE_CLIENT) return;
    const snapshot = JSON.stringify({ data, theme });
    const lastSnapshot = STORAGE.getItem('historySnapshot');
    if (snapshot === lastSnapshot) return;

    const versionName = `Contexto ${CONTEXT_ID} - ${new Date().toLocaleString('es-ES')}`;
    const payload = createHistoryPayload(versionName, data, theme);

    const { error } = await SUPABASE_CLIENT
        .from('banners_historial')
        .insert(payload)
        .select()
        .limit(1);

    if (error) {
        console.warn('Supabase history auto save error', error.message);
        return;
    }

    STORAGE.setItem('historySnapshot', snapshot);
}

async function saveVersion() {
    const input = document.getElementById('versionName');
    const trimmedName = input ? (input.value || '').trim() : '';
    const versionName = trimmedName || `Contexto ${CONTEXT_ID} - ${new Date().toLocaleString('es-ES')}`;
    if (!versionName) {
        alert('Ingresa un nombre para la versi\u00f3n.');
        return;
    }

    const data = JSON.parse(STORAGE.getItem('bannerData') || '{}');
    const theme = JSON.parse(STORAGE.getItem('themeConfig') || '{}');
    if (!SUPABASE_CLIENT) {
        alert('Base de datos deshabilitada.');
        return;
    }

    const payload = createHistoryPayload(versionName, data, theme);

    const { error } = await SUPABASE_CLIENT
        .from('banners_historial')
        .insert(payload)
        .select()
        .limit(1);

    if (error) {
        console.warn('Supabase history save error', error.message);
        showToast('No se pudo guardar el historial.', 'error');
        return;
    }

    document.getElementById('versionName').value = '';
    STORAGE.setItem('historySnapshot', JSON.stringify({ data, theme }));
    showToast('Versi�n guardada correctamente', 'success');
    loadVersionsList();
}

async function loadVersionsList() {
    const listContainer = document.getElementById('versionsList');
    listContainer.innerHTML = '<p style="color: #999; text-align: center;">Cargando historial...</p>';

    if (EMBED_MODE) {
        listContainer.innerHTML = '<p style="color: #999; text-align: center;">Historial no disponible en embeds.</p>';
        return;
    }

    if (!SUPABASE_CLIENT) {
        listContainer.innerHTML = '<p style="color: #999; text-align: center;">Base de datos deshabilitada.</p>';
        return;
    }

    cancelRenameVersion();

    const { bannerId, cedula } = getHistoryFilter();
    if (!bannerId && !cedula) {
        listContainer.innerHTML = '<p style="color: #999; text-align: center;">Guarda un banner con c�dula para ver el historial.</p>';
        return;
    }

    let query = SUPABASE_CLIENT
        .from('banners_historial')
        .select('id, created_at, version_name, banner_id, cedula')
        .order('created_at', { ascending: false })
        .limit(50);

    if (bannerId) {
        query = query.eq('banner_id', bannerId);
    } else {
        query = query.eq('cedula', cedula);
    }

    const { data, error } = await query;
    if (error) {
        console.warn('Supabase history fetch error', error.message);
        listContainer.innerHTML = '<p style="color: #999; text-align: center;">No se pudo cargar el historial.</p>';
        try { showToast('Sin conexi�n a Supabase. Verifica tu red o dominio bloqueado.', 'error'); } catch(e) {}
        try { setDbStatus('error', 'Base de datos: sin conexi�n'); } catch(e) {}
        return;
    }

    if (!data || data.length === 0) {
        listContainer.innerHTML = '<p style="color: #999; text-align: center;">No hay versiones guardadas a\u00fan.</p>';
        return;
    }

    listContainer.innerHTML = data.map(version => {
        const date = version.created_at ? new Date(version.created_at).toLocaleDateString('es-ES') : '';
        const name = version.version_name || 'Versi\u00f3n';
        const safeName = escapeHtml(name);
        const encodedName = encodeURIComponent(name);
        return `
        <div class="version-item">
            <div class="version-name">${safeName}</div>
            <div class="version-date">${date}</div>
            <div class="version-buttons">
                <button class="version-btn" onclick="loadVersion('${version.id}')">Cargar</button>
                <button class="version-btn" data-id="${version.id}" data-name="${encodedName}" onclick="renameVersionFromButton(this)">Renombrar</button>
                <button class="version-btn delete" onclick="deleteVersion('${version.id}')">Eliminar</button>
            </div>
        </div>
    `;
    }).join('');
}

async function loadVersion(versionId) {
    if (!SUPABASE_CLIENT) return;

    const { data, error } = await SUPABASE_CLIENT
        .from('banners_historial')
        .select('*')
        .eq('id', versionId)
        .limit(1);

    if (error) {
        console.warn('Supabase history load error', error.message);
        showToast('No se pudo cargar la versi�n.', 'error');
        return;
    }

    const row = Array.isArray(data) ? data[0] : data;
    if (!row) return;

    const mapped = {
        name: row.nombre || '',
        school: row.escuela || '',
        email: row.email || '',
        phone: row.telefono || '',
        cedula: row.cedula || '',
        whatsappPersonal: row.whatsapp || '',
        whatsappGroup: row.grupo_whatsapp || '',
        comments: sanitizeAdditionalInfo(row.informacion_adicional, row),
        photo: row.foto_url || ''
    };

    const theme = {
        primaryColor: row.color_primario || THEMES['sunset'].primary,
        accentColor: row.color_secundario || THEMES['sunset'].accent
    };

    if (row.banner_id) {
        STORAGE.setItem('bannerId', row.banner_id);
    } else {
        STORAGE.removeItem('bannerId');
    }

    hydrateUI(mapped, theme);
    STORAGE.setItem('historySnapshot', JSON.stringify({ data: mapped, theme }));
    closeVersionsModal();
    showToast('Versi�n cargada correctamente', 'success');
}

function renameVersionFromButton(btn) {
    if (!btn) return;
    const encoded = btn.dataset.name || '';
    startRenameVersion(btn.dataset.id, encoded);
}

function startRenameVersion(versionId, encodedName = '') {
    const box = document.getElementById('versionRenameBox');
    const input = document.getElementById('renameVersionInput');
    const save = document.getElementById('renameVersionSave');
    if (!box || !input || !save) return;
    let decoded = '';
    try {
        decoded = encodedName ? decodeURIComponent(encodedName) : '';
    } catch (e) {
        decoded = '';
    }
    input.value = decoded;
    save.dataset.id = versionId || '';
    box.style.display = 'block';
    input.focus();
    try { input.select(); } catch (e) {}
}

function cancelRenameVersion() {
    const box = document.getElementById('versionRenameBox');
    const input = document.getElementById('renameVersionInput');
    const save = document.getElementById('renameVersionSave');
    if (box) box.style.display = 'none';
    if (input) input.value = '';
    if (save) save.dataset.id = '';
}

async function renameVersion(versionId = '') {
    if (!SUPABASE_CLIENT) {
        showToast('Base de datos deshabilitada.', 'error');
        return;
    }
    const box = document.getElementById('versionRenameBox');
    const input = document.getElementById('renameVersionInput');
    const save = document.getElementById('renameVersionSave');
    const targetId = versionId || (save ? save.dataset.id : '');
    if (!input || !save || !targetId) {
        showToast('No se pudo identificar la versi�n.', 'error');
        return;
    }

    const trimmed = (input.value || '').trim();
    if (!trimmed) {
        alert('El nombre no puede estar vac�o.');
        return;
    }

    let prevLabel = save.textContent;
    save.textContent = 'Guardando...';
    save.disabled = true;

    const { error } = await SUPABASE_CLIENT
        .from('banners_historial')
        .update({ version_name: trimmed })
        .eq('id', targetId);

    save.textContent = prevLabel || 'Guardar';
    save.disabled = false;

    if (error) {
        console.warn('Supabase history rename error', error.message);
        showToast('No se pudo renombrar la versi�n.', 'error');
        return;
    }

    showToast('Versi�n renombrada', 'success');
    cancelRenameVersion();
    loadVersionsList();
}

async function deleteVersion(versionId) {
    if (!confirm('�Est\u00e1s seguro de que deseas eliminar esta versi\u00f3n?')) return;
    if (!SUPABASE_CLIENT) return;

    const { error } = await SUPABASE_CLIENT
        .from('banners_historial')
        .delete()
        .eq('id', versionId);

    if (error) {
        console.warn('Supabase history delete error', error.message);
        showToast('No se pudo eliminar la versi�n.', 'error');
        return;
    }

    loadVersionsList();
}
        function showSaveStatus() {
            const status = document.getElementById('saveStatus');
            status.classList.add('show');
            setTimeout(() => status.classList.remove('show'), 2000);
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.textContent = message;
            toast.classList.remove('show', 'success', 'error');
            if (type) toast.classList.add(type);
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2200);
        }

        function openFormModal() {
            document.getElementById('formModal').classList.add('active');
            if (EMBED_MODE) {
                return;
            }
            const currentId = STORAGE.getItem('bannerId');
            if (currentId) STORAGE.setItem('lastBannerId', currentId);
            STORAGE.removeItem('bannerId');
            clearFormModal();
        }

        function closeFormModal() {
            document.getElementById('formModal').classList.remove('active');
        }

        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        function openEmbedModal() {
            openEmbedGenerator();
        }

        function closeEmbedModal() {
            document.getElementById('embedModal').classList.remove('active');
        }

        async function copyEmbedCode() {
            const textarea = document.getElementById('embedCode');
            const status = document.getElementById('embedStatus');
            if (!textarea) return;
            const code = textarea.value;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(code);
                } else {
                    textarea.select();
                    document.execCommand('copy');
                }
                if (status) {
                    status.style.display = 'block';
                    setTimeout(() => status.style.display = 'none', 2000);
                }
            } catch (e) {
                alert('No se pudo copiar. Copia manualmente con CtrlC.');
            }
        }

        function openConfigModal() {
            document.getElementById('configModal').classList.add('active');
            try{ updateConfigPreview(); }catch(e){}
        }

        function closeConfigModal() {
            document.getElementById('configModal').classList.remove('active');
        }

        function openVersionsModal() {
            document.getElementById('versionsModal').classList.add('active');
            loadVersionsList();
        }

        function closeVersionsModal() {
            document.getElementById('versionsModal').classList.remove('active');
            cancelRenameVersion();
        }

        

        window.onclick = function (event) {
            const formModal = document.getElementById('formModal');
            const exportModal = document.getElementById('exportModal');
            const configModal = document.getElementById('configModal');
            const versionsModal = document.getElementById('versionsModal');
            const embedModal = document.getElementById('embedModal');
            
            if (event.target === exportModal) exportModal.classList.remove('active');
            if (event.target === configModal) configModal.classList.remove('active');
            if (event.target === versionsModal) versionsModal.classList.remove('active');
            if (event.target === embedModal) embedModal.classList.remove('active');
        };

        let cedulaLookupTimer = null;
        let lastCedulaLookup = '';

        function scheduleCedulaLookup(value) {
            if (EMBED_MODE) return;
            const normalized = normalizeCedula(value);
            if (normalized.length === 0) {
                setCedulaStatus('', '');
                return;
            }
            if (normalized === lastCedulaLookup) return;
            if (cedulaLookupTimer) clearTimeout(cedulaLookupTimer);
            cedulaLookupTimer = setTimeout(() => {
                lookupCedulaAndFill(value);
            }, 500);
        }

        const cedulaInput = document.getElementById('cedula');
        if (cedulaInput) {
            cedulaInput.addEventListener('input', (event) => {
                scheduleCedulaLookup(event.target.value);
            });
            cedulaInput.addEventListener('blur', (event) => {
                lookupCedulaAndFill(event.target.value);
            });
        }

        // Initialize
        if (EMBED_MODE) {
            document.querySelector('.btn-versions')?.setAttribute('style', 'display:none;');
        }
        loadData();
        try { updateBanner(); } catch (e) { console.error(e); }

        // SOLO EN MODO PREVIEW: ESCUCHAR ACTUALIZACIONES
        if (MODE === "preview" || MODE === "view") {
            window.addEventListener("message", (event) => {
                if (!event.data || event.data.type !== "BANNER_UPDATE") return;

                STORAGE.setItem(
                    "bannerData",
                    JSON.stringify(event.data.payload.data)
                );

                STORAGE.setItem(
                    "themeConfig",
                    JSON.stringify(event.data.payload.theme)
                );

                updateBanner();
            });

            // Opcional: ocultar botones en preview
            try {
                document.querySelector(".button-group")?.remove();
                document.querySelector(".header")?.remove();
                document.querySelectorAll(".form-section").forEach(el => el.remove());
                const previewTitle = document.querySelector(".preview-section h2");
                if (previewTitle) previewTitle.remove();

                // Dejar solo el banner en pantalla
                const banner = document.getElementById("bannerPreview");
                const previewSection = document.querySelector(".preview-section");
                if (banner && previewSection) {
                    previewSection.replaceWith(banner);
                    banner.style.margin = "0 auto";
                    banner.style.maxWidth = "900px";
                }
                document.body.style.padding = "20px";
                document.querySelector(".container")?.style.setProperty("max-width", "100%");
                document.querySelector(".container")?.style.setProperty("margin", "0");
            } catch (e) {}
        }
    </script>
</body>
</html>
           











